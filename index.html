<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Precio de productos Wow</title>
    <link rel="icon" href="https://findicons.com/files/icons/679/nx10/128/world_of_warcraft.png">
    <!-- filestack Libreria -->
    <script defer src="https://static.filestackapi.com/filestack-js/3.x.x/filestack.min.js"></script>
    <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- JavaScript Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"></script>
    <!--jquery 3-->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!--Toastr-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet">
    <!--Grafica-->
    <script defer async src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <!--CSS del Tooltip de informacion de producto-->
    <link rel="stylesheet" href="css/styleTooltipInfoProducto.css">
    <!--CSS de todos los estilos de la app-->
    <link rel="stylesheet" href="css/stylePrincipalApp.css">
</head>

<body>


    <section>
        <!-- ************************** HTML MODAL *************************** -->

        <div class="modal fade" id="staticBackdrop" id="Modal" data-bs-backdrop="static" data-bs-keyboard="false"
            tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div id="modalContent" class="modal-content">
                    <div class="modal-header">
                        <img id="imgVentanita" src="" alt="">
                        <h5 class="modal-title" id="ventanaTitulo"></h5><br>
                        <h5 class="" id="precioTitulo"></h5>
                        <button id="cerrarModalId" type="button" class="btn-close" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>
                    <div class="modal-body">

                        <!--Tabs de titulo ventanita-->
                        <ul class="nav nav-tabs" id="myTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <a href="#DiaDeVentaTabHref" class="nav-link active" id="DiaDeVentaTabId"
                                    data-bs-toggle="tab" data-bs-target="#home" type="button" role="tab"
                                    aria-controls="home" aria-selected="true">Dias de
                                    venta</a>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="graficasTab" data-bs-toggle="tab" data-bs-target="#profile"
                                    type="button" role="tab" aria-controls="profile" aria-selected="false">Gráficas de
                                    análisis</button>
                            </li>
                        </ul>

                        <!--contenidos de las tabs-->
                        <div class="tab-content">
                            <div class="tab-pane active" id="home" role="tabpanel" aria-labelledby="home-tab">
                                <div id="divForm" class="divForm d-flex justify-content-center">
                                    <form action="">
                                        <div class="d-flex justify-content-center">
                                            <h6 id="PventaLabel" for="fname">Precio de venta:</h6><br>
                                        </div>
                                        <input type="number" class="Pventa" id="PventaId" name="fname">
                                        <b for="moneda" id="monedaId"></b>
                                        <br>
                                        <div class="d-flex justify-content-center">
                                            <input class="btn btn-success" id="btnCambiar" type="button"
                                                value="Cambiar ▼">
                                        </div>
                                    </form>
                                </div>
                                <br>
                                <table id="tablaVerificacion" border="1">
                                    <tr>
                                        <th>Día</th>
                                        <th>#</th>
                                        <th>Precio alcanzado</th>
                                        <th>Hora</th>
                                    </tr>
                                </table>
                            </div>
                            <div class="tab-pane" id="profile" role="tabpanel" aria-labelledby="profile-tab">
                                <!-----------------------GRAFICA DE ANALISIS Flipping------------------------>
                                <div class="graficaFlipping"></div>
                            </div>
                        </div>

                        <!-- FIN DE Todo dentro de la ventanita -->
                    </div>
                </div>
            </div>
        </div>

        <!-- *************** HTML MODAL COMPONENTES DE CRAFTEO ****************** -->
        <div class="modal fade" id="modalComponentes" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
            aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div id="modalConentID" class="modal-content">
                    <div class="modal-header">
                        <div id="container">
                            <img id="imgModalProducto" src="" alt="">
                            <div id="divTextCircularId">
                                <div id="txtCantidadPorStackId">1</div>
                            </div>
                        </div>
                        <h5 class="modal-title" id="tituloModalNombreProducto">mt</h5>
                        <input type="number" min="1" oninput="this.value|=0" id="inputCantidadComp" value="1">
                        <input type="button" id="btnEnviarCantidadComp" value=">">
                    </div>

                    <!-- Las tablas de componentes -->
                    <div class="modal-body">

                        <!--Tabla nombre Componentes-->
                        <ul class="nav nav-tabs justify-content-center" id="myTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <a href="#ComponenteHref" class="nav-link active" id="componentesTab"
                                    data-bs-toggle="tab" data-bs-target="#componentesTabId" type="button" role="tab"
                                    aria-controls="profile" aria-selected="false">Componentes</a>
                            </li>
                            <!--Tabla nombre Días de venta-->
                            <li class="nav-item" role="presentation">
                                <a href="#DiaDeVentaTabHref" disabled class="nav-link" id="DiaDeVentaTabIdComp"
                                    data-bs-toggle="tab" data-bs-target="#diasVentaTabCompId" type="button" role="tab"
                                    aria-controls="home" aria-selected="true">Días de venta</a>
                            </li>
                        </ul>

                        <!--contenido de las tabs de componentes-->
                        <div class="tab-content">

                            <div class="tab-pane active" id="componentesTabId" role="tabpanel"
                                aria-labelledby="home-tab">
                                <div id="divTablaComponente">
                                    <table id="tablaComponentes" border="1">
                                        <tr>
                                            <th>Img</th>
                                            <th>Nombre</th>
                                            <th>Precio de compra</th>
                                            <th>hasta el 5%</th>
                                            <th>Cantidad</th>
                                        </tr>
                                    </table>
                                    <h5 id="txtInvertido"></h5>
                                    <h5 id="txtGananciaAprox"></h5>
                                </div>

                                <div class="d-flex justify-content-center">
                                    <div id="divBase">
                                        <div id="divtitulo">
                                            <div id="TituloDatosAdicionales">Datos adicionales</div> <br>
                                        </div>
                                        <div id="divDatosAdicionales">
                                            <b id="bIdComp">- Precio Individual: </b>
                                            <b id="bIdPrecioIndividual">0</b>
                                            <br>
                                            <b id="bIdComp">- x1 Precio de venta: </b>
                                            <b id="bIdPrecioDeVenta">0</b>
                                            <br>
                                            <b id="bIdComp">- Precio promedio: </b>
                                            <b id="bIdPrecioPromedio"></b>
                                            <br>
                                            <b id="bIdComp">- Cantidad en subasta: </b>
                                            <b id="bIdCantidadPublicada"></b>
                                            <br>
                                            <b id="bIdComp"></b>
                                            <b id="bIdUltimoEscaneo"></b>
                                            <img id="iconoModalId" src="icons/check.png" alt="">
                                        </div>
                                    </div>
                                </div>

                                <!-- ****************** Grafica de analisis en crafting componente tab ****************** -->
                                <div class="graficaCrafting"></div>
                            </div>

                            <!-------------------Contenido dias de venta Tab en comp------------------------>
                            <div class="tab-pane" id="diasVentaTabCompId" role="tabpanel" aria-labelledby="profile-tab">

                                <div id="divForm" class="divForm d-flex justify-content-center">
                                    <form action="">
                                        <div class="d-flex justify-content-center">
                                            <h6 id="PventaLabel" for="fname">Precio de promedio:</h6><br>
                                        </div>
                                        <input type="number" min="0" class="Pventa" id="PventaIdComp" name="fname"
                                            value="0">
                                        <b for="moneda" id="monedaId"></b>
                                        <br>
                                        <div class="d-flex justify-content-center">
                                            <input class="btn btn-success" id="btnCambiarComp" type="button"
                                                value="Cambiar ▼">
                                        </div>
                                    </form>
                                </div>
                                <br>
                                <table id="tablaVerificacionComp" border="1">
                                    <tr id="trDiasVenta">
                                        <th>Día</th>
                                        <th>#</th>
                                        <th>Precio alcanzado</th>
                                        <th>Hora</th>
                                    </tr>
                                </table>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ************************* HTML PRINCIPAL *************************** -->
        <div id="idDivOpacity">
            <div class="d-flex justify-content-center">
                <h1 id="titulo">Protuctos en subasta (Wow TBC)</h1>
            </div>
            <div id="idContenedor">

                <div class="row align-items-center">
                    <!-- Columna 1 del row* -->
                    <div class="columnas col-8">
                        <b id="servidorLabel">Servidor:</b>
                        <select id="dropdownServidor">
                            <option value="Pagle-alliance">Pagle Alianza</option>
                            <option value="Whitemane-horde">Whitemane Horda</option>
                        </select>

                        <b id="idiomaLabel">Expansion:</b>
                        <select id="dropdownExpansion">
                            <option value="Todos">Todos</option>
                            <option value="Classic">Classic</option>
                            <option value="Tbc">Tbc</option>
                            <option value="Wotlk">Wotlk</option>
                        </select>

                        <b id="idiomaLabel">Categoría:</b>
                        <select id="dropdownCategoriaProductos">
                        </select>
                    </div>
                    <!-- Columna 2 del row* -->
                    <div class="columnas col-4">
                        <b id="letras" id="servidorLabel">Selecciona el proveedor de precios:</b><br>
                        <div id="divDatosOnline" class="form-check">
                            <input id="radioCheckNexus" class="form-check-input" type="radio" value="radioNexus"
                                name="flexRadioDisabled" id="flexRadioDisabled" checked>
                            <label id="letras" class="form-check-label" for="flexRadioDisabled">
                                Datos Online
                            </label>
                        </div>
                        <div class="form-check">
                            <input id="radioCheckArchivo" class="form-check-input" type="radio" value="radioLocalJson"
                                name="flexRadioDisabled">
                            <label id="letras" class="form-check-label" for="flexRadioCheckedDisabled">
                                Datos de escaneo Local
                            </label>
                            <button id="BtnSubirArchivo" type="button" class="btn btn-primary">Subir Archivo</button>
                        </div>
                    </div>
                    <p id="lastUpdated">- Último escaneo: Esperando información...</p>
                </div>
            </div>

            <!-- ******************Tabs titulo***************** -->
            <ul class="nav nav-tabs justify-content-center" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="crafteoTab" data-bs-toggle="tab" data-bs-target="#crafteo"
                        type="button" role="tab" aria-controls="profile" aria-selected="false">Crafteo</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="flippingTab" data-bs-toggle="tab" data-bs-target="#flipping"
                        type="button" role="tab" aria-controls="home" aria-selected="true">Flipping</button>
                </li>
            </ul>

            <!-- ******************Contenido de las tabs principales****************** -->
            <div class="tab-content">
                <!--Tab de Crafting-->
                <div class="tab-pane fade show active" id="crafteo" role="tabpanel" aria-labelledby="crafteoTab">
                    <progress id="progressBarCraft" value="0%" max="100"></progress>
                    <div id="divTabCraft">
                        <table id="crafteoTabla" border="1">
                            <tr id="trCraftId">
                                <th>Imagen</th>
                                <th>Nombre</th>
                                <th>Inversión de crafteo</th>
                                <th>Precio Individual</th>
                                <th>Precio de venta x1</th>
                                <th>Ganancia</th>
                                <th>%</th>
                                <th>Nivel</th>
                                <th>Receta</th>
                                <th>Componentes</th>
                            </tr>
                        </table>
                        <div>
                            <h4 id="txtNotificacion"></h4>
                        </div>
                    </div>
                </div>
                <!--Tab de Flipping-->
                <div class="tab-pane" id="flipping" role="tabpanel" aria-labelledby="flippingTab">
                    <progress id="progressBar" value="0%" max="100"></progress>
                    <div id="divTablaId">
                        <table id="productos" border="1">
                            <tr id="trFlippingId">
                                <th>Imagen</th>
                                <th>Nombre</th>
                                <th>Precio Compra</th>
                                <th>Compra hasta el 15%</th>
                                <th>Precio de venta</th>
                                <th>Ganancia Aproximada</th>
                                <th id="porcentaje">%</th>
                                <th>Cantidad</th>
                                <th>Herramientas</th>
                            </tr>
                        </table>
                    </div>
                    <div>
                        <h4 id="txtNotificacionCrafteo">Seleccione una categoría para cargar la lista.</h4>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </section>

    <script type="module">
        //firestore imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.9.2/firebase-app.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/9.9.2/firebase-firestore.js"
        import { collection, getDocs, addDoc, doc, setDoc, updateDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/9.9.2/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB4a33fFr6SgUAXjZ6FeFB_XDGL6SKuCuY",
            authDomain: "wowprices-74a82.firebaseapp.com",
            projectId: "wowprices-74a82",
            storageBucket: "wowprices-74a82.appspot.com",
            messagingSenderId: "380944707410",
            appId: "1:380944707410:web:2f229f9fbf99d96e39148b"
        };

        const app = initializeApp(firebaseConfig);
        //variables para firestore
        var infoProductosArray = []
        var infoProductosActualizadosJson = { "infoProducts": {} }
        var precioActualizado = ""
        var fechaActualizada = ""

        //variables de precios y fechas por servidores
        var precioPagle = 0
        var fechaPagle = 0
        var precioWhitemane = 0
        var fechaWhitemane = 0

        //id elementos html
        var tablaProducto = document.getElementById('productos');
        var tablaCrafting = document.getElementById('crafteoTabla');
        var cuerpoTablaFlipping = document.createElement('tbody');
        var cuerpoTablaCrafting = document.createElement('tbody');
        var cuerpoTablaComponentes = document.createElement('tbody');
        var cuerpoTablaDiasVentaEnComp = document.createElement('tbody')
        var divDatosOnline = document.getElementById("divDatosOnline")
        var divId = document.getElementById("divPassId")
        var btnEnviarCantidadComp = document.getElementById("btnEnviarCantidadComp")
        var corsBoton = document.getElementById('corsBtn');
        var NotificacionText = document.getElementById("txtNotificacion")
        var NotificacionTextCrafteo = document.getElementById("txtNotificacionCrafteo")
        var ultimaFecha = document.getElementById("lastFecha")
        var ventanaTituloId = document.getElementById("ventanaTitulo")
        var precioTituloId = document.getElementById("precioTitulo")
        var monedaNombreId = document.getElementById("monedaId")
        var btnSubir = document.getElementById('BtnSubirArchivo');
        var selectCategoria = document.createElement('dropdownCategoriaProductos');
        var dropdownServidor = document.getElementById('dropdownServidor')
        var dropdownExpansion = document.getElementById("dropdownExpansion")
        var tituloModalNombreProducto = document.getElementById("tituloModalNombreProducto")
        var imgModalProducto = document.getElementById("imgModalProducto")
        var RadioArchivo = document.getElementById("radioCheckArchivo")
        var RadioNexusVar = document.getElementById("radioCheckNexus")
        var bIdCantidadPublicada = document.getElementById("bIdCantidadPublicada")
        var bIdPrecioPromedio = document.getElementById("bIdPrecioPromedio")
        var bIdPrecioIndividual = document.getElementById("bIdPrecioIndividual")
        var bIdPrecioDeVenta = document.getElementById("bIdPrecioDeVenta")
        var positivoNegativo = ""
        var RadioValorSelected = ""
        var multiplicaCantidadPorPrecioSimple = 0
        var nombreTituloActualEnComponenteModal = ""
        var nivelProfesionRequerido = 0
        var server = ""
        var arrayDeCategoriaFlipping = []
        var arrayDeCategoriaCrafteo = []
        var reagentesTotales = []
        var ladoDelTabId = 0
        var corsurl = "https://api.codetabs.com/v1/proxy?quest="
        toastr.options = {
            "closeButton": false,
            "debug": false,
            "newestOnTop": false,
            "progressBar": false,
            "positionClass": "toast-top-right",
            "preventDuplicates": true,
            "onclick": null,
            "showDuration": "300",
            "hideDuration": "200",
            "timeOut": "3000",
            "extendedTimeOut": "500",
            "showEasing": "swing",
            "hideEasing": "linear",
            "showMethod": "fadeIn",
            "hideMethod": "fadeOut"
        }

        //VARIABLES DEL LA VENTANITA
        var txtCantidadPorStackId = document.getElementById("txtCantidadPorStackId")
        var tablaVerificacion = document.getElementById('tablaVerificacion');
        var tablaComponentes = document.getElementById('tablaComponentes')
        var tablaDiasVentaComp = document.getElementById("tablaVerificacionComp")
        var divCharFlippng = document.querySelector(".graficaFlipping")
        var divCharCrafting = document.querySelector(".graficaCrafting")
        var divTextCircularId = document.getElementById("divTextCircularId")
        var iconoModal = document.getElementById("iconoModalId")
        var tbody = document.createElement('tbody');
        var campoTextprecioDeVentaID = document.getElementById("PventaId")
        var campoTextprecioDeVentaIDEnComp = document.getElementById("PventaIdComp")
        var campoTextprecioDeVentaIDEnCompValue = 0
        var campoTextoValor = document.getElementById("PventaId").value
        var precioDeVentaEnTablaNro = 0
        var tipoMonedaOroPlataBronce = ""
        var nombreUnico = ""
        var precioDeVenta = parseFloat(campoTextoValor) * 10000
        var diaSemana = ""
        var NombreProductoClickeado = ""
        var precioMinimo = ""
        var diaSemanaAnterior = "Sat"
        var cantidades = 0
        var MismaVentana = false
        var chart = ""
        var fechaEnModal = ""
        var modalVisible = false

        //variable de ventana componentes
        var precioPromedioEnComp = 0
        var nameunicoDeProductoEnGrafic = ""
        var jsonDeSieteDiazHistorico = ""
        var vieneDeClickBtnCambiarEnComp = false

        //-------------------------------eventos on click y change-------------------------------------

        //Abre el panel para agregar productos
        document.addEventListener('keydown', function (event) {
            if (event.ctrlKey && event.key === 'z') {
                window.open("dashboard/panel.html", "_blank");
            }
        });

        //Recalcula cuando presionas enter en el input dias de venta en componentes
        campoTextprecioDeVentaIDEnComp.addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
                event.preventDefault()
                cambiarPrecioVntaBtnComp()
            }
        });

        //Recalcula cuando presionas enter en el input dias de venta en Flipping
        document.getElementById("PventaId").addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
                event.preventDefault()
                cambiarPrecioVntaBtn()
            }
        });
        //click en la tab de flipping
        try {
            document.getElementById("flippingTab").addEventListener("click", function (params) {
                ladoDelTabId = 1
                if (RadioNexusVar.checked == true) {

                } else {
                    RadioValorSelected = RadioArchivo.value

                }
                //Limpia la tabla de categoria actual
                $("#dropdownCategoriaProductos").empty();
                divDatosOnline.style = "visibility: visible;"
                //Coloca la categoría de Flipping
                for (const key in arrayDeCategoriaFlipping) {
                    const element = arrayDeCategoriaFlipping[key];
                    var daySelect = document.getElementById('dropdownCategoriaProductos');
                    daySelect.options[daySelect.options.length] = new Option(element, element);
                }
            })
        } catch (error) {
        }

        //click en la tab de crafteo
        try {
            document.getElementById("crafteoTab").addEventListener("click", function (params) {
                ladoDelTabId = 0
                //Limpia la tabla de categoria actual
                $("#dropdownCategoriaProductos").empty();
                divDatosOnline.style = "visibility: hidden;"
                RadioArchivo.checked = true;
                RadioValorSelected = RadioArchivo.value
                btnSubir.style.visibility = "visible";
                lastUpdated(fechaActualizada)
                //Coloca la categoría de Crafting
                for (const key in arrayDeCategoriaCrafteo) {
                    const element = arrayDeCategoriaCrafteo[key];
                    var daySelect = document.getElementById('dropdownCategoriaProductos');
                    daySelect.options[daySelect.options.length] = new Option(element, element);
                }
            })
        } catch (error) {
        }

        //click en la tab de Dias de venta en Flipping
        try {
            document.getElementById("DiaDeVentaTabId").addEventListener("click", function (params) {
                if (MismaVentana == true) {
                    precioTituloId.innerText = ""
                }
            })
        } catch (error) {
        }

        //click en la tab de Dias de venta en componente
        try {
            document.getElementById("DiaDeVentaTabIdComp").addEventListener("click", function (params) {
                SolicitarDatosDiaDeVentaCrafteo(nameunicoDeProductoEnGrafic, jsonDeSieteDiazHistorico)
            })
        } catch (error) {
        }

        //click en la tab de Componentes
        try {
            document.getElementById("componentesTab").addEventListener("click", function (params) {
                vieneDeClickBtnCambiarEnComp = false
            })
        } catch (error) {
        }

        //click en la tab de graficas
        try {
            document.getElementById("graficasTab").addEventListener("click", function (params) {
                //al hacer click en ventana graficas
            })
        } catch (error) {
        }

        //Click al cerrar el modal
        document.getElementById("cerrarModalId").addEventListener("click", function (params) {
            MismaVentana = false
            modalVisible = false
            try {
                chart.clearAnnotations()
                chart.destroy()
                console.log("destruido")
            } catch (error) {

            }
            ventanaTituloId.innerText = ""
            precioTituloId.innerText = ""
        })

        //evento cuando se cierra el modal de los componentes
        $("#modalComponentes").on("hide.bs.modal", function () {
            modalVisible = false
            vieneDeClickBtnCambiarEnComp = false
            try {
                chart.clearAnnotations()
                chart.destroy()
                console.log("destruido")
            } catch (error) {

            }
            multiplicaCantidadPorPrecioSimple = 0
            inputCantidadComp.value = 1
            bIdCantidadPublicada.innerText = ""
            bIdPrecioPromedio.innerText = ""
        });

        //cuando cambia el dropdown select producto
        document.getElementById('dropdownCategoriaProductos').addEventListener('change', function () {
            if (ladoDelTabId == 0) {
                SeleccionListaCategoriaCrafteo()
            } else if (ladoDelTabId == 1) {
                SeleccionListaProducto()
            }
        });

        //cuando cambia el dropdown de expansion
        document.getElementById('dropdownExpansion').addEventListener('change', function () {
            if (ladoDelTabId == 0) {
                SeleccionListaCategoriaCrafteo()
            } else if (ladoDelTabId == 1) {
                SeleccionListaExpansion()
            }
        });

        //cuando cambia el dropdown de servidor
        document.getElementById('dropdownServidor').addEventListener('change', function (event) {
            if (ladoDelTabId == 0) {
                SeleccionListaCategoriaCrafteo()
            } else if (ladoDelTabId == 1) {
                SeleccionListaServidor()
            }
        });

        //cuando haces click en el Radio nexus
        document.getElementById('radioCheckNexus').addEventListener('click', function () {
            RadioValorSelected = RadioNexusVar.value
            CheckNexusSelected()
        });
        //cuando haces click en el Radio archivo local
        document.getElementById('radioCheckArchivo').addEventListener('click', function () {
            RadioValorSelected = RadioArchivo.value
            CheckArchivoSelected()

        });

        //cuando haces click en el boton cambiar de la ventanita
        document.getElementById('btnCambiar').addEventListener('click', function () {
            cambiarPrecioVntaBtn()
        });

        //cuando haces click en el boton cambiar de la ventanita de componente
        document.getElementById('btnCambiarComp').addEventListener('click', function () {
            cambiarPrecioVntaBtnComp()
        });

        //cuando haces click en el boton subir archivo
        document.getElementById('BtnSubirArchivo').addEventListener('click', function () {
            subirArchivoJson()
        });

        //variables del html principal
        var vueltasBucle = 0

        //obtiene el valor de ambos dropdown
        var dropdownProductosValor = document.getElementById("dropdownCategoriaProductos").value
        var urlNexusArray = []
        var NombreProductoArray = new Array()

        //Inicia tratendo los datos y categorias del la base de datos
        leerDatos()

        //Inserta a todas las tablas el tbody
        tablaCrafting.appendChild(cuerpoTablaCrafting)
        tablaVerificacion.appendChild(tbody);
        tablaComponentes.appendChild(cuerpoTablaComponentes)
        tablaDiasVentaComp.appendChild(cuerpoTablaDiasVentaEnComp)
        tablaProducto.appendChild(cuerpoTablaFlipping);

        //.............................Funciones de crafteo...............................................
        var namesito = ""
        var canti = 0
        var tooltipInfoProductoArray = []

        //Funcion que muestra o quita el tooltip de la info del producto
        async function traerProductoCrafteo(urlProductos, key, infoProductosArray, idioma, NombreEspañol, nombreUnicoProducto, precioActualizado, crafteoComponente, iconoImg, nivelProfesionRequerido, receta, fechaActualizada, CantidadPorCreacion, valorInvertidoEntreCantCreada, tooltipInfoProducto) {
            var dropdownServidorValue = dropdownServidor.value
            var cantidadComponentes = 0
            var nameComponente = ""
            var sumaDeComponentes = 0
            var multiplicaCantidadPorPrecio = 0
            var ganancia = 0

            //Precio viales en el npc
            var vialNames = [
                "vial emplomado",
                "vial imbuido",
                "vial vacío",
                "vial de cristal",
                "vial encantado"
            ]
            //Precio viales en el npc
            var papiroNames = [
                "papiro ligero",
                "papiro en blanco",
                "papiro pesado",
                "papiro resilente",
                "papiro común"
            ]

            try {
                var precioComponenteSumados = 0
                var precio = 0
                var precioSimple = 0

                for (const key in crafteoComponente) {
                    //................PAGLE........................
                    if (dropdownServidorValue == "Pagle-alliance") {
                        precio = precioActualizado
                        precioSimple = precio / 10000
                        //Comprueba si viene un vial de alquimia o un papiro de inscripcion para pagle
                        //y le coloca su precio de npc en lugar de la subasta
                        if (vialNames.includes(crafteoComponente[key].nombreEnEspañol)) {
                            var precioComp = vialPriceNpc(crafteoComponente[key].nombreEnEspañol) * 10000
                            multiplicaCantidadPorPrecio = precioComp * crafteoComponente[key].cantidad

                        } else if (papiroNames.includes(crafteoComponente[key].nombreEnEspañol)) {
                            var precioComp = papiroPriceNpc(crafteoComponente[key].nombreEnEspañol) * 10000
                            multiplicaCantidadPorPrecio = precioComp * crafteoComponente[key].cantidad
                        } else {
                            // multiplica de una vez el precio x la cantidad de componentes en server Pagle
                            multiplicaCantidadPorPrecio = crafteoComponente[key].precioActualPagle * crafteoComponente[key].cantidad

                        }

                        //................WHITEMANE........................
                    } else if (dropdownServidorValue == "Whitemane-horde") {
                        precio = precioActualizado
                        precioSimple = precio / 10000

                        //Comprueba si viene un vial de alquimia o un papiro de inscripcion para whitemane
                        //y le coloca su precio de npc en lugar de la subasta

                        if (vialNames.includes(crafteoComponente[key].nombreEnEspañol)) {
                            var precioComp = vialPriceNpc(crafteoComponente[key].nombreEnEspañol) * 10000
                            multiplicaCantidadPorPrecio = precioComp * crafteoComponente[key].cantidad

                        } else if (papiroNames.includes(crafteoComponente[key].nombreEnEspañol)) {
                            var precioComp = papiroPriceNpc(crafteoComponente[key].nombreEnEspañol) * 10000
                            multiplicaCantidadPorPrecio = precioComp * crafteoComponente[key].cantidad
                        } else {
                            // multiplica de una vez el precio x la cantidad de componentes en server Whitemane
                            multiplicaCantidadPorPrecio = crafteoComponente[key].precioActualWhitemane * crafteoComponente[key].cantidad

                        }
                    }
                    //suma el resultado anterior con precio nuevo
                    sumaDeComponentes = sumaDeComponentes + multiplicaCantidadPorPrecio
                }
                //El valor de la inversion dividido entre la cantidaddes que salen al ser creados
                var valorInvertidoEntreCantCreada = sumaDeComponentes / CantidadPorCreacion / 10000
                //El valor de la inversion al sumar todos los componentes
                var multiplicaCantidadPorPrecioSimple = sumaDeComponentes / 10000

                //el valor de la ganancia
                ganancia = precioSimple - valorInvertidoEntreCantCreada
                var gananciaSimple = ganancia // ejemp : transforma 29000 -> 2.90

                if (nivelProfesionRequerido != 0) {
                    var idImagenes = "dentro" + key //el Id de la imagen con su key/index para ponerlo en el innerHTML

                    //agrega los datos a a tabla
                    var fila = document.createElement('tr');

                    //Pone la imagen del producto
                    var td = document.createElement('td');
                    td.innerHTML = `
                    <div id="container">
                        <img id="imgModalProducto" src="`+ iconoImg + `" alt="">
                        <div id="divTextCircularId">
                            <div id="txtCantidadPorStackId">`+ CantidadPorCreacion + `</div>
                        </div>
                        <span id="`+ idImagenes + `" class="tooltiptext"></span>
                    </div>
                    `;
                    //cuando le pasa el raton sobre la imagen
                    td.onmouseenter = function () {
                        document.getElementById(idImagenes).style.visibility = "visible";
                        document.getElementById(idImagenes).innerHTML = tooltipInfoProductoArray[key]
                    }
                    td.onmouseleave = function () {
                        document.getElementById(idImagenes).style.visibility = "hidden";
                    }
                    fila.appendChild(td);


                    //crea el nombre
                    var td = document.createElement('td');
                    td.innerText = NombreEspañol
                    td.setAttribute("style", "font-weight:bold");
                    fila.appendChild(td);

                    //crea el precio de crafteo
                    td = document.createElement('td');
                    td.setAttribute("style", "font-weight:bold");

                    td.innerText = PlataOro(multiplicaCantidadPorPrecioSimple);
                    fila.appendChild(td);

                    //crea el precio individual
                    td = document.createElement('td');
                    td.setAttribute("style", "font-weight:bold");

                    td.innerText = PlataOro(valorInvertidoEntreCantCreada);
                    fila.appendChild(td);

                    //crea el precio de venta x1
                    td = document.createElement('td');
                    td.setAttribute("style", "font-weight:bold");
                    if (nivelProfesionRequerido != 0) {
                        td.innerText = PlataOro(precioSimple);
                    } else {
                        td.innerText = "-"
                    }
                    fila.appendChild(td);

                    //crea la ganancia
                    var td = document.createElement('td');
                    if (nivelProfesionRequerido != 0) {
                        td.innerText = PlataOro(gananciaSimple);
                    } else {
                        td.innerText = "-"
                    }
                    td.setAttribute("style", "font-weight:bold");
                    fila.appendChild(td);

                    //crea el % de ganancia
                    td = document.createElement('tr');
                    td = document.createElement('td');
                    var gananciaEstimada = gananciaPromedia(valorInvertidoEntreCantCreada, precioSimple).toFixed(4)
                    var porcentajeGanancia = gananciaEstimada / valorInvertidoEntreCantCreada * 100
                    if (porcentajeGanancia.toString() == "NaN") {
                        porcentajeGanancia = -100
                    }
                    if (porcentajeGanancia.toFixed(2) < 0) {

                        td.setAttribute("style", "color:red");
                    } else if (porcentajeGanancia.toFixed(2) > 0) {
                        //color verde si es mayor a 0%
                        td.setAttribute("style", "color:#00af1d");
                    }
                    td.innerText = porcentajeGanancia.toFixed(2) + " %"
                    fila.appendChild(td);

                    //crea el nivel de profesion requerido
                    var td = document.createElement('td');
                    td.innerText = nivelProfesionRequerido
                    fila.appendChild(td);

                    //crea si usa receta o no
                    var td = document.createElement('td');
                    var HayReceta = ""
                    if (receta != "No") {
                        HayReceta = "Si"
                        td.innerText = HayReceta
                    } else {
                        td.innerText = receta
                    }

                    td.setAttribute("style", "cursor: pointer; border: red")

                    td.onclick = function (evt) {
                        var UrlWowheadReceta = "https://www.wowhead.com/wotlk/es/item="
                        if (HayReceta == "Si") {
                            window.open(UrlWowheadReceta + receta[0], "_blank");
                        }
                    }
                    fila.appendChild(td);

                    //crea el boton para el modal de componentes
                    var td = document.createElement('td');
                    td.innerText = "Ver"
                    td.setAttribute("data-bs-toggle", "modal")
                    td.setAttribute("data-bs-target", "#modalComponentes")
                    td.setAttribute("style", "cursor: pointer")
                    td.onclick = function (evt) {
                        LimpiarTablaComponentes()
                        //coloca la imagen en el titulo
                        imgModalProducto.src = iconoImg
                        nombreTituloActualEnComponenteModal = NombreEspañol
                        var nombreUrlProductoUnico = nombreUnicoProducto
                        //coloca el nombre en el titulo
                        tituloModalNombreProducto.innerText = NombreEspañol

                        //Al abrir pone la tab en componente
                        $('a[href="#ComponenteHref"]').tab('show')

                        //pinta los datos en la tabla de los componentes para 1 producto
                        var numeroEnInput = inputCantidadComp.value
                        recalcularDatosComponentes(numeroEnInput, multiplicaCantidadPorPrecioSimple, precioSimple, dropdownServidorValue, nombreUrlProductoUnico, fechaActualizada, gananciaSimple, valorInvertidoEntreCantCreada)

                        //Muestra los datos adicionales
                        traerDatosAdicionales(precioSimple, nombreUrlProductoUnico)

                        //cuando presionas enter en el input del nro recalcula tambien
                        document.getElementById("inputCantidadComp").addEventListener('keydown', function (event) {
                            if (event.key === 'Enter') {
                                event.preventDefault()
                                var inputNumberComp = inputCantidadComp.value
                                LimpiarTablaComponentes()
                                recalcularDatosComponentes(inputNumberComp, multiplicaCantidadPorPrecioSimple, precioSimple, dropdownServidorValue, nombreUrlProductoUnico, fechaActualizada, gananciaSimple, valorInvertidoEntreCantCreada)
                            }
                        });

                        //cuando haces click en el boton dentro del modal componente
                        document.getElementById('btnEnviarCantidadComp').addEventListener('click', function () {
                            var inputNumberComp = inputCantidadComp.value
                            LimpiarTablaComponentes()
                            recalcularDatosComponentes(inputNumberComp, multiplicaCantidadPorPrecioSimple, precioSimple, dropdownServidorValue, nombreUrlProductoUnico, fechaActualizada, gananciaSimple, valorInvertidoEntreCantCreada)
                        });
                    }

                    fila.appendChild(td);
                    //doble click en la fila
                    fila.ondblclick = function (evt) {
                        copiarNombreProducto(NombreEspañol)
                    }
                    tablaCrafting.appendChild(fila);
                }

                // filtra la tabla por mayor % cada vez q se agregan a la tabla
                sortTableCrafting()

            } catch (error) {
                console.log(error)
            }

        }

        //Seleccion del dropdown de productos
        function SeleccionListaCategoriaCrafteo() {

            if (dropdownProductosValue != "Seleccionar Profesion") {
                var dropdownProductosValue = document.getElementById("dropdownCategoriaProductos").value
                var dropdownExpansionValue = dropdownExpansion.value
                var dropdownServidorValue = dropdownServidor.value
                LimpiarTablaCrafting()

                for (const key in infoProductosArray) {
                    var urlNormal = infoProductosArray[key].url
                    var urlProductos = obtenerUrlCrafteo(urlNormal, dropdownServidorValue)
                    var NombreEspañol = infoProductosArray[key].traduccion
                    var iconoImg = infoProductosArray[key].icono
                    var categoria = infoProductosArray[key].categoria
                    var receta = infoProductosArray[key].receta
                    var nivelProfesionRequerido = infoProductosArray[key].nivelUsoProfesion
                    var expansion = infoProductosArray[key].expansion
                    var nombreUnicoProducto = infoProductosArray[key].nombreUnico
                    var crafteoComponente = infoProductosArray[key].craftingComponentes
                    var CantidadPorCreacionLentgh = infoProductosArray[key].craftingComponentes.length
                    var tooltipInfoProducto = infoProductosArray[key].tooltipInfo
                    tooltipInfoProductoArray.push(tooltipInfoProducto)

                    //trae solo los productos en la categoria seleccionada
                    if (infoProductosArray[key].craftingCategory == dropdownProductosValue) {
                        if (CantidadPorCreacionLentgh > 0) {
                            var CantidadPorCreacion = infoProductosArray[key].craftingComponentes[0].cantidadPorCreacion
                        }

                        if (dropdownServidor.value == "Pagle-alliance") {
                            precioActualizado = infoProductosArray[key].servidor.pagle.precioActualizado
                            fechaActualizada = infoProductosArray[key].servidor.pagle.FechaActualizada

                        } else if (dropdownServidor.value == "Whitemane-horde") {
                            precioActualizado = infoProductosArray[key].servidor.whitemane.precioActualizado
                            fechaActualizada = infoProductosArray[key].servidor.whitemane.FechaActualizada
                        }
                        if (dropdownProductosValue == infoProductosArray[key].craftingCategory && dropdownExpansionValue == infoProductosArray[key].expansion) {

                            traerProductoCrafteo(urlProductos, key, infoProductosArray, "Español", NombreEspañol, nombreUnicoProducto, precioActualizado, crafteoComponente, iconoImg, nivelProfesionRequerido, receta, fechaActualizada, CantidadPorCreacion, tooltipInfoProducto)

                        } else if (dropdownProductosValue == infoProductosArray[key].craftingCategory && dropdownExpansionValue == "Todos") {

                            traerProductoCrafteo(urlProductos, key, infoProductosArray, "Español", NombreEspañol, nombreUnicoProducto, precioActualizado, crafteoComponente, iconoImg, nivelProfesionRequerido, receta, fechaActualizada, CantidadPorCreacion, tooltipInfoProducto)
                        }

                    }
                }

                lastUpdated(fechaActualizada)
            } else {
                // NotificacionTextCrafteo.innerText = "Selecciona una profesión para cargar la lista!"
            }
        }

        // ************** JS ventanita de crafteo *******************************

        //Funcion que recalcula los datos en el modal de componentes
        function recalcularDatosComponentes(numeroEnInput, multiplicaCantidadPorPrecioSimple, precioDeVenta, server, nombreProductoUnico, fechaActualizada, gananciaSimple, valorInvertidoEntreCantCreada) {

            //Precio viales en el npc
            var vialNames = [
                "vial emplomado",
                "vial imbuido",
                "vial vacío",
                "vial de cristal",
                "vial encantado"
            ]
            //Precio viales en el npc
            var papiroNames = [
                "papiro ligero",
                "papiro en blanco",
                "papiro pesado",
                "papiro resilente",
                "papiro común"
            ]

            //pone el ID a las graficas del modal que se este abriendo flipping o crafting
            divCharFlippng.id = "SinUso"
            divCharCrafting.id = "chart"
            var urlDatosDeGrafica = "https://api.nexushub.co/wow-classic/v1/items/" + dropdownServidor.value + "/" + nombreProductoUnico + "/prices"
            //trae los datos del historia de 7 dias para ponerlos en la gráfica
            modalVisible = true
            obtenerDatosDeGrafica(urlDatosDeGrafica)

            for (const key in infoProductosArray) {
                if (infoProductosArray[key].traduccion == nombreTituloActualEnComponenteModal) {
                    var arrayComponentes = infoProductosArray[key].craftingComponentes
                    var fechaEnModalTimeStamp = infoProductosArray[key].servidor.pagle.FechaActualizada

                    for (const llave in arrayComponentes) {
                        var idComp = arrayComponentes[llave].itemId
                        var iconoComp = arrayComponentes[llave].icono
                        var nombreComp = arrayComponentes[llave].nombreUnico
                        var nameEspañolComp = arrayComponentes[llave].nombreEnEspañol
                        var cantidadPorCreacion = parseInt(arrayComponentes[llave].cantidadPorCreacion)
                        if (cantidadPorCreacion >= 10) {
                            divTextCircularId.setAttribute("style", "height:24px; width:24px; top:32px; right:0px;")
                            txtCantidadPorStackId.setAttribute("style", "top:-1px; right:3px;")
                            txtCantidadPorStackId.innerText = cantidadPorCreacion
                        } else {
                            divTextCircularId.setAttribute("style", "height:20px; width:20px; top:35px; right:0px;")
                            txtCantidadPorStackId.setAttribute("style", "top:-3.5px; right:5.5px;")
                            txtCantidadPorStackId.innerText = cantidadPorCreacion
                        }

                        if (server == "Pagle-alliance") {
                            var precioComp = arrayComponentes[llave].precioActualPagle / 10000

                        } else if (server == "Whitemane-horde") {
                            var precioComp = arrayComponentes[llave].precioActualWhitemane / 10000
                        }
                        var cantidadComp = arrayComponentes[llave].cantidad * parseInt(numeroEnInput)
                        //agrega los datos a a tabla
                        var fila = document.createElement('tr');

                        //la imagen del componente
                        var div_caption = document.createElement('div');
                        var img = document.createElement('img');
                        img.src = iconoComp;
                        fila.appendChild(div_caption);
                        fila.appendChild(img);


                        //Comprueba si viene un vial de alquimia o un papiro de inscripcion
                        //y le coloca su precio de npc en lugar de la subasta
                        if (vialNames.includes(nameEspañolComp)) {
                            precioComp = vialPriceNpc(nameEspañolComp)

                        } else if (papiroNames.includes(nameEspañolComp)) {
                            if (nameEspañolComp == "papiro en blanco") {
                                nameEspañolComp = "papiro común"
                            }
                            precioComp = papiroPriceNpc(nameEspañolComp)
                        }


                        //crea el nombre
                        var td = document.createElement('td');
                        td.innerText = nameEspañolComp
                        td.setAttribute("style", "font-weight:bold; cursor:pointer;");
                        fila.appendChild(td);

                        //crea el precio del componente
                        var td = document.createElement('td');
                        td.innerText = PlataOro(precioComp)
                        td.setAttribute("style", "font-weight:bold");
                        fila.appendChild(td);

                        //crea que te dice que compres hasta el 5% max
                        var td = document.createElement('td');
                        //calcula un 5% menos a la ganancia final
                        var menosjincoPorciento = parseFloat(precioComp).toFixed(2) * 5 / 100
                        var totalConDescuentoCinco = precioComp + menosjincoPorciento
                        td.innerText = PlataOro(totalConDescuentoCinco)
                        td.setAttribute("style", "font-weight:bold");
                        fila.appendChild(td);

                        //crea la cantidad de componentes a comprar
                        var td = document.createElement('td');
                        td.innerText = cantidadComp
                        td.setAttribute("style", "font-weight:bold");
                        fila.appendChild(td);

                        //doble click en la fila
                        fila.ondblclick = function (evt) {
                            console.log(evt)
                            var nameEspClicked = evt.target.innerText

                            copiarNombreProducto(nameEspClicked)
                        }
                        tablaComponentes.appendChild(fila);
                    }
                }
            }
            var invertidoEnComp = document.getElementById("txtInvertido")
            var gananciaEnComp = document.getElementById("txtGananciaAprox")
            //Precio individual
            bIdPrecioIndividual.innerText = PlataOro(valorInvertidoEntreCantCreada)
            //Calcula el total invertido en componentes
            var multiplicaCantidad = multiplicaCantidadPorPrecioSimple * parseInt(numeroEnInput)
            invertidoEnComp.innerText = "Total invertido = " + PlataOro(multiplicaCantidad)
            //Calcula la ganancia aproximada 
            var multiplicaPrecioPorCantidad = precioDeVenta * parseInt(numeroEnInput)
            var gananciaAprox = gananciaSimple * parseInt(numeroEnInput)

            //calcula un 7% menos a la ganancia final
            var menosSietePorciento = parseFloat(gananciaAprox).toFixed(2) * 7 / 100
            var totalConDescuento = gananciaAprox - menosSietePorciento
            if (gananciaAprox > 0) {
                //color verde si hay ganancia
                gananciaEnComp.setAttribute("style", "color:#00af1d")
                gananciaEnComp.innerText = "Ganancia aprox entre = " + PlataOroEspecial(totalConDescuento.toFixed(2)) + " a " + PlataOro(gananciaAprox)
            } else if (gananciaAprox < 0) {
                //color rojo si hay perdida
                gananciaEnComp.setAttribute("style", "color: red")
                gananciaEnComp.innerText = "La pérdida es = " + PlataOro(gananciaAprox)
            }


            //Pone la hora del último escaneo de este producto
            var fechaAcual = lastUpdatedModalComp(fechaActualizada)
            var fechaVieja = lastUpdatedModalComp(fechaEnModalTimeStamp)

            if (fechaAcual == fechaVieja) {
                iconoModal.src = "icons/check.png"

            } else if (fechaAcual != fechaVieja) {
                iconoModal.src = "icons/warning.png"
            }
            document.getElementById("bIdUltimoEscaneo").innerText = lastUpdatedModalComp(fechaEnModalTimeStamp)

        }

        async function traerDatosAdicionales(precioDeVentaLocal, nameUnicoProducto) {
            for (let index = 0; index < 3; index++) {
                var urlDatosAdicionales = "https://api.nexushub.co/wow-classic/v1/items/" + dropdownServidor.value + "/" + nameUnicoProducto
                try {
                    bIdPrecioDeVenta.innerText = PlataOro(precioDeVentaLocal)
                    const respuesta = await fetch(corsurl + urlDatosAdicionales)
                    const json = await respuesta.json()
                    bIdPrecioPromedio.innerText = PlataOro(json.stats.current.marketValue / 10000)
                    bIdCantidadPublicada.innerText = json.stats.current.quantity
                    break
                } catch (error) {
                    console.log(error)
                }
            }
        }

        async function SolicitarDatosDiaDeVentaCrafteo() {
            /*  if (tipoMonedaOroPlataBronce == "Oro") {
                  precioDeVentaEnTablaNro = precioDeVentaEnTablaNro * 10000
              } else if (tipoMonedaOroPlataBronce == "Plata") {
                  precioDeVentaEnTablaNro = precioDeVentaEnTablaNro * 100
                  
              } else if (tipoMonedaOroPlataBronce == "Cobre") {
                  precioDeVentaEnTablaNro = precioDeVentaEnTablaNro * 10
              }*/

            LimpiarTablaVerificacionEnComp()

            var urlDatosAdicionales = "https://api.nexushub.co/wow-classic/v1/items/" + dropdownServidor.value + "/" + nameunicoDeProductoEnGrafic
            var precioPromedioEnComp = 0
            //Viene desde la primera vez que se toca la tab dias de venta en comp
            if (vieneDeClickBtnCambiarEnComp == false) {
                try {
                    const respuesta = await fetch(corsurl + urlDatosAdicionales)
                    const jsonResp = await respuesta.json()
                    precioPromedioEnComp = jsonResp.stats.current.marketValue
                    campoTextprecioDeVentaIDEnComp.value = parseFloat(precioPromedioEnComp / 10000).toFixed(2)

                } catch (error) {
                    toastr.warning("Espere que cargue la gráfica para ver esta información.", "Mensaje")
                }

                //Si viene el click del boton de cambiar
            } else if (vieneDeClickBtnCambiarEnComp == true) {

                precioPromedioEnComp = campoTextprecioDeVentaIDEnComp.value * 10000
            }

            //pone el ID a las graficas del modal que se este abriendo flipping o crafting
            divCharFlippng.id = "chart"
            divCharCrafting.id = "SinUso"
            //trae los datos del historia de 7 dias para ponerlos en la gráfica
            modalVisible = true

            for (var index = 0; index < jsonDeSieteDiazHistorico.data.length; index++) {

                const d = new Date(jsonDeSieteDiazHistorico.data[index].scannedAt);
                var hora = hora24a12(d.getHours())
                var minuto = minutosConCero(d.getMinutes())
                var horaMinutos = hora[0] + ":" + minuto + " " + hora[1]
                var diaSemana = d.toString().split(" ")[0]
                var precioCompra = jsonDeSieteDiazHistorico.data[index].minBuyout

                if (precioCompra > precioPromedioEnComp) {
                    //verifica si el dia de la semana es el mismo o ha cambiado
                    if (diaSemana == diaSemanaAnterior) {
                        //en caso que sea el mismo dia
                        cantidades = cantidades + 1
                        diaSemanaAnterior = diaSemana
                        precioCompra = PlataOro(precioCompra / 10000)
                        crearColumnaEnComp(diaSemana, cantidades, precioCompra, horaMinutos)

                    } else {
                        //cuando cambia a otro dia de la semana
                        cantidades = 1
                        diaSemanaAnterior = diaSemana
                        precioCompra = PlataOro(precioCompra / 10000)
                        crearColumnaEnComp(diaSemana, cantidades, precioCompra, horaMinutos)
                    }
                }
            }
            if (vieneDeClickBtnCambiarEnComp == true) {
                toastr.success("Datos cambiados!", "Mensaje")
            }
        }

        //.............................Funciones de Flipping...............................................

        //LEE LOS DATOS DE FIREBASE
        async function leerDatos() {
            NotificacionText.innerText = "Cargando los datos por favor espere..."
            for (let index = 0; index < 3; index++) {
                try {
                    var RadioArchivoValor = RadioArchivo.value
                    var RadioNexusValor = RadioNexusVar.value

                    //Define el Valor del radio al cargar la página
                    if (RadioNexusValor = "radioNexus") {
                        RadioValorSelected = RadioNexusValor
                    } else if (RadioArchivoValor = "radioLocalJson") {
                        RadioValorSelected = RadioArchivoValor
                    }

                    divDatosOnline.style = "visibility: hidden;"
                    RadioArchivo.checked = true;
                    RadioValorSelected = RadioArchivo.value
                    btnSubir.style.visibility = "visible";

                    // Inicializa Firebase si no esta inicializado
                    const app = initializeApp(firebaseConfig);

                    const db = getFirestore(app);
                    enableIndexedDbPersistence(db)
                        .catch((err) => {
                            if (err.code == 'failed-precondition') {
                                console.log("El modo Offline es solo con una ventana abierta!" + err.code)
                                toastr.warning("El modo Offline es solo con una ventana abierta!")

                            } else if (err.code == 'unimplemented') {
                                console.log("No funciona el modo Offline en este navegador!" + err.code)
                            }
                        });
                    const colRef = collection(db, "data");
                    const docsSnap = await getDocs(colRef);
                    docsSnap.forEach(doc => {

                        //agrega las categorias al dropdown
                        for (const key in doc.data().tipo) {
                            const element = doc.data().tipo[key];
                            arrayDeCategoriaFlipping.push(doc.data().tipo[key])
                        }
                        //guarda la categoria de crafteo en un array
                        for (const key in doc.data().crafting) {
                            const elementCategoryCraft = doc.data().crafting[key];
                            var daySelect = document.getElementById('dropdownCategoriaProductos');
                            daySelect.options[daySelect.options.length] = new Option(elementCategoryCraft, elementCategoryCraft);
                            arrayDeCategoriaCrafteo.push(elementCategoryCraft)
                        }

                        for (const key in doc.data().infoProducts) {
                            var urlNormal = doc.data().infoProducts[key].url
                            var urlProductos = obtenerUrlConServer(urlNormal, dropdownServidor.value)
                            var NombreEspañol = doc.data().infoProducts[key].traduccion
                            var categoria = doc.data().infoProducts[key].categoria
                            var expansion = doc.data().infoProducts[key].expansion
                            var nombreUnicoProduct = doc.data().infoProducts[key].nombreUnico
                            var ExpansionValue = dropdownExpansion.value

                            if (dropdownServidor.value == "Pagle-alliance") {
                                precioActualizado = doc.data().infoProducts[key].servidor.pagle.precioActualizado
                                fechaActualizada = doc.data().infoProducts[key].servidor.pagle.FechaActualizada

                            } else if (dropdownServidor.value == "Whitemane-horde") {
                                precioActualizado = doc.data().infoProducts[key].servidor.whitemane.precioActualizado
                                fechaActualizada = doc.data().infoProducts[key].servidor.whitemane.FechaActualizada

                            }
                            //guarda en un nuevo array toda la mercancia traida de la base de datos
                            infoProductosArray.push(doc.data().infoProducts[key])
                        }

                        NotificacionText.innerText = "Seleccione una categoría para cargar la lista."
                        lastUpdated(fechaActualizada)
                    }).catch(function (reason) {
                        console.log(reason)
                        toastr.error("Error al cargar los datos!", "Mensaje:")
                    });

                } catch (error) {

                }

            }

        }

        //Abre los URL de los productos trae sus datos en una tablas (Funcion principal)
        async function traerProductoDatos(urlProductos, indice, array, idioma, NombreEspañol, nombreUnicoProducto, precioActual) {

            for (let i = 0; i <= 4; i++) {
                try {
                    var corsurl = "https://api.codetabs.com/v1/proxy?quest="
                    //abre el url
                    const respuesta = await fetch(corsurl + urlProductos)
                    const json = await respuesta.json()
                    //Variable del producto
                    var productName = json.name
                    var uniqueName = json.uniqueName
                    var imagen = json.icon
                    //Si el radio es de nexus deja el precio online
                    if (RadioValorSelected == "radioNexus") {
                        var precioMinimo = json.stats.current.minBuyout / 10000

                    } else if (RadioValorSelected == "radioLocalJson") {
                        //Si el radio es del archivo deja ese precio
                        var precioMinimo = precioActual / 10000
                    }
                    var precioPromedio = json.stats.current.marketValue / 10000
                    var gananciaEstimada = gananciaPromedia(precioMinimo, precioPromedio).toFixed(4)
                    var porcentajeGanancia = gananciaEstimada / precioMinimo * 100
                    var cantidades = json.stats.current.quantity

                    //Verifica si el idioma es español
                    if (idioma == "Español") {
                        productName = NombreEspañol
                    }

                    //agrega los datos a a tabla
                    var fila = document.createElement('tr');

                    //la imagen del producto
                    var div_caption = document.createElement('div');
                    var img = document.createElement('img');
                    img.src = imagen;
                    fila.appendChild(div_caption);
                    fila.appendChild(img);

                    //crea el nombre
                    var td = document.createElement('td');
                    td.innerText = productName
                    td.setAttribute("style", "font-weight:bold");
                    fila.appendChild(td);

                    //crea el precio minimo
                    td = document.createElement('td');
                    td.setAttribute("style", "font-weight:bold");
                    td.innerText = PlataOro(precioMinimo);
                    fila.appendChild(td);

                    //crea el compra hasta el 15%
                    td = document.createElement('td');
                    var compraMaxima = CompraMaxima(precioPromedio, porcentajeGanancia)
                    if (compraMaxima == "-") {
                        td.innerText = compraMaxima;
                    } else {
                        td.innerText = PlataOro(compraMaxima);
                    }
                    td.setAttribute("style", "font-weight:bold");
                    fila.appendChild(td);

                    //crea el precio promedio
                    td = document.createElement('td');
                    td.innerText = PlataOro(precioPromedio);
                    td.setAttribute("style", "font-weight:bold");
                    fila.appendChild(td);

                    //crea la ganancia estimada
                    td = document.createElement('td');
                    td.innerText = PlataOro(gananciaEstimada);
                    //agrega color verde si es positivo y rojo si es negativo
                    if (positivoNegativo == true) {
                        td.setAttribute("style", "color:#00af1d");
                    } else {
                        td.setAttribute("style", "color:red");
                    }
                    fila.appendChild(td);

                    //crea el % de ganancia
                    td = document.createElement('tr');
                    td = document.createElement('td');
                    if (positivoNegativo == true) {

                        if (porcentajeGanancia.toFixed(2) < 20 && porcentajeGanancia.toFixed(2) > 0) {

                            td.setAttribute("style", "color:#dfdb00");
                        } else if (porcentajeGanancia.toFixed(2) > 20) {
                            //color verde si es mayor a 20%
                            td.setAttribute("style", "color:#00af1d");
                        }
                    } else {
                        td.setAttribute("style", "color:red");
                    }
                    td.innerText = porcentajeGanancia.toFixed(2) + " %"
                    fila.appendChild(td);

                    //crea las cantidades publicadas
                    td = document.createElement('tr');
                    td = document.createElement("td");
                    td.innerText = cantidades
                    fila.appendChild(td);

                    //crea el boton de la heramienta de venta
                    td = document.createElement('tr');
                    td = document.createElement("td");
                    NombreProductoArray.push(productName)
                    td.innerText = "Abrir";
                    td.setAttribute("data-bs-toggle", "modal")
                    td.setAttribute("data-bs-target", "#staticBackdrop")
                    td.setAttribute("style", "cursor: pointer")
                    td.onclick = function (evt) {
                        //agarra el texto de la tabla y lo coloca en la ventana segun el producto
                        campoTextprecioDeVentaID = document.getElementById("PventaId")
                        //pone el nombre del producto en el titulo de la ventanita
                        NombreProductoClickeado = evt.path[1].childNodes[2].innerHTML
                        ventanaTituloId.innerText = NombreProductoClickeado
                        //pone la imagen del producto en el titulo de la ventanita
                        var imagenProductoClickado = evt.path[1].childNodes[1].currentSrc
                        document.getElementById("imgVentanita").src = imagenProductoClickado

                        //obtiene el valor del precio de venta sugerido en la tabla
                        var precioDeVentaEnTablaTexto = evt.path[1].childNodes[5].innerHTML
                        precioDeVentaEnTablaNro = evt.path[1].childNodes[5].innerHTML.split(" ")[0]
                        tipoMonedaOroPlataBronce = evt.path[1].childNodes[5].innerHTML.split(" ")[1]
                        //pone el precio obtenido de la tabla "precio venta" en el campo de texto
                        campoTextprecioDeVentaID.value = precioDeVentaEnTablaNro

                        //Pone al lado de campo de texto el tipo de moneda
                        monedaNombreId.innerText = tipoMonedaOroPlataBronce

                        //Nombre del producto con guion ejemp: scroll-of-agility-iv
                        nombreUnico = nombreUnicoProducto

                        //Al abrir pone la tab en la primera
                        $('a[href="#DiaDeVentaTabHref"]').tab('show');

                        //inicia la consulta
                        SolicitarDatos(precioDeVentaEnTablaNro, tipoMonedaOroPlataBronce, nombreUnico)

                    }
                    fila.appendChild(td);

                    //doble click en la fila
                    fila.ondblclick = function (evt) {

                        copiarNombreProducto(NombreEspañol)
                    }

                    cuerpoTablaFlipping.appendChild(fila);
                    vueltasBucle = 0

                    // filtra la tabla por mayor % cada vez q se agregan a la tabla
                    sortTable()

                    break
                } catch (error) {
                    console.log(error)
                    console.log(urlProductos)
                }
            }
        }

        //Filtra la lista por la expansion del juego
        function SeleccionListaExpansion() {
            var dropdownProductosValue = document.getElementById("dropdownCategoriaProductos").value
            var dropdownExpansionValue = dropdownExpansion.value
            var dropdownServidorValue = dropdownServidor.value
            if (dropdownProductosValue != "Seleccionar") {
                NotificacionText.innerText = ""
                //Carga la hora del ultimo escarneo
                LimpiarTabla()

                const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms))

                const loop = async () => {
                    var count = 0
                    for (const key in infoProductosArray) {

                        var urlNormal = infoProductosArray[key].url
                        var urlProductos = obtenerUrlConServer(urlNormal, dropdownServidor.value)
                        var NombreEspañol = infoProductosArray[key].traduccion
                        var categoria = infoProductosArray[key].categoria
                        var expansion = infoProductosArray[key].expansion
                        var nombreUnicoProducto = infoProductosArray[key].nombreUnico

                        if (dropdownServidor.value == "Pagle-alliance") {
                            precioActualizado = infoProductosArray[key].servidor.pagle.precioActualizado
                            fechaActualizada = infoProductosArray[key].servidor.pagle.FechaActualizada

                        } else if (dropdownServidor.value == "Whitemane-horde") {
                            precioActualizado = infoProductosArray[key].servidor.whitemane.precioActualizado
                            fechaActualizada = infoProductosArray[key].servidor.whitemane.FechaActualizada
                        }

                        if (dropdownProductosValue == infoProductosArray[key].categoria && dropdownExpansionValue == infoProductosArray[key].expansion) {
                            count = ProgressBar(count)
                            traerProductoDatos(urlProductos, key, infoProductosArray, "Español", NombreEspañol, nombreUnicoProducto, precioActualizado)
                        } else if (dropdownProductosValue == infoProductosArray[key].categoria && dropdownExpansionValue == "Todos") {
                            count = ProgressBar(count)
                            traerProductoDatos(urlProductos, key, infoProductosArray, "Español", NombreEspañol, nombreUnicoProducto, precioActualizado)
                        }
                        count = count + 1
                        await wait(250)
                    }
                }
                loop()
                lastUpdated(fechaActualizada)
            } else {
                NotificacionText.innerText = "Seleccione una categoría para cargar la lista."
            }
        }

        //Filtra la lista por el servidor elejido
        function SeleccionListaServidor() {
            var dropdownProductosValue = document.getElementById("dropdownCategoriaProductos").value
            var dropdownExpansionValue = dropdownExpansion.value
            var dropdownServidorValue = dropdownServidor.value
            if (dropdownProductosValue != "Seleccionar") {
                NotificacionText.innerText = ""
                LimpiarTabla()

                const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms))

                const loop = async () => {
                    var count = 0
                    for (const key in infoProductosArray) {

                        var urlNormal = infoProductosArray[key].url
                        var urlProductos = obtenerUrlConServer(urlNormal, dropdownServidor.value)
                        var NombreEspañol = infoProductosArray[key].traduccion
                        var categoria = infoProductosArray[key].categoria
                        var expansion = infoProductosArray[key].expansion
                        var nombreUnicoProducto = infoProductosArray[key].nombreUnico

                        if (dropdownServidorValue == "Pagle-alliance") {
                            precioActualizado = infoProductosArray[key].servidor.pagle.precioActualizado
                            fechaActualizada = infoProductosArray[key].servidor.pagle.FechaActualizada

                        } else if (dropdownServidorValue == "Whitemane-horde") {
                            precioActualizado = infoProductosArray[key].servidor.whitemane.precioActualizado
                            fechaActualizada = infoProductosArray[key].servidor.whitemane.FechaActualizada
                        }

                        if (dropdownProductosValue == infoProductosArray[key].categoria && dropdownExpansionValue == infoProductosArray[key].expansion) {
                            count = ProgressBar(count)
                            traerProductoDatos(urlProductos, key, infoProductosArray, "Español", NombreEspañol, nombreUnicoProducto, precioActualizado)
                        } else if (dropdownProductosValue == infoProductosArray[key].categoria && dropdownExpansionValue == "Todos") {
                            count = ProgressBar(count)
                            traerProductoDatos(urlProductos, key, infoProductosArray, "Español", NombreEspañol, nombreUnicoProducto, precioActualizado)
                        }
                        count = count + 1
                        await wait(250)
                    }
                }
                loop()
                //Carga la hora del ultimo escarneo
            } else {
                NotificacionText.innerText = "Seleccione una categoría para cargar la lista."
            }
            lastUpdated(fechaActualizada)
        }

        //Seleccion del dropdown de productos
        function SeleccionListaProducto() {
            var dropdownProductosValue = document.getElementById("dropdownCategoriaProductos").value
            var dropdownExpansionValue = dropdownExpansion.value
            var dropdownServidorValue = dropdownServidor.value
            if (dropdownProductosValue != "Seleccionar") {
                console.log("aqui en lista producto")
                txtNotificacionCrafteo.innerText = ""

                LimpiarTabla()

                const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms))

                const loop = async () => {
                    var count = 0
                    for (const key in infoProductosArray) {

                        var urlNormal = infoProductosArray[key].url
                        var urlProductos = obtenerUrlConServer(urlNormal, dropdownServidorValue)
                        var NombreEspañol = infoProductosArray[key].traduccion
                        var categoria = infoProductosArray[key].categoria
                        var expansion = infoProductosArray[key].expansion
                        var nombreUnicoProducto = infoProductosArray[key].nombreUnico

                        if (dropdownServidor.value == "Pagle-alliance") {
                            precioActualizado = infoProductosArray[key].servidor.pagle.precioActualizado
                            fechaActualizada = infoProductosArray[key].servidor.pagle.FechaActualizada

                        } else if (dropdownServidor.value == "Whitemane-horde") {
                            precioActualizado = infoProductosArray[key].servidor.whitemane.precioActualizado
                            fechaActualizada = infoProductosArray[key].servidor.whitemane.FechaActualizada
                        }

                        if (dropdownProductosValue == infoProductosArray[key].categoria && dropdownExpansionValue == infoProductosArray[key].expansion) {
                            count = ProgressBar(count)
                            traerProductoDatos(urlProductos, key, infoProductosArray, "Español", NombreEspañol, nombreUnicoProducto, precioActualizado)

                        } else if (dropdownProductosValue == infoProductosArray[key].categoria && dropdownExpansionValue == "Todos") {
                            count = ProgressBar(count)
                            traerProductoDatos(urlProductos, key, infoProductosArray, "Español", NombreEspañol, nombreUnicoProducto, precioActualizado)
                        }
                        //Carga la hora del ultimo escarneo
                        count = count + 1
                        await wait(250)
                    }
                }
                loop()
                lastUpdated(fechaActualizada)
            } else {
                txtNotificacionCrafteo.innerText = "Seleccione una categoría para cargar la lista."
                LimpiarTabla()
            }
        }

        //Barra de progreso de la carga
        function ProgressBar(countValue) {
            var value1 = countValue
            var value2 = countValue + 1
            var table_content = '<table><tr>'
                + '<td style= "font-size: 10px;" >' + value1 + '</td>'
                + '<td style= "font-size: 10px;" >' + value2 + '</td>'
                + '<td style= "font-size: 10px;" >'
                + '</div>'
                + '</div>'
                + '</tr></table>';
            document.querySelector('#progressBar').value = (countValue + 1)
            return countValue
        }

        //leer el json subido y lo procesa para subirlo a firestore
        async function leerJsonSubido(url) {
            const db = getFirestore(app);
            const Ref = doc(db, "data", "datos");
            var amount = 0
            var componenteNombreUnico = ""

            for (let indice = 0; indice < 3; indice++) {

                try {
                    var dropdownProductosValue = document.getElementById("dropdownCategoriaProductos").value
                    var dropdownExpansionValue = dropdownExpansion.value
                    var dropdownServidorValue = dropdownServidor.value

                    //Inicia trayendo los datos del json subido a Filestacks
                    const respuesta = await fetch(url)
                    const respuestaArchivoJson = await respuesta.json()
                    console.log("Archivo escaneado (2/4)")
                    var fechaUltimoScan = respuestaArchivoJson.FechaUltimoScan //Fecha ultimo escaneo
                    server = respuestaArchivoJson.servidor.toString()
                    //console.log("servidor: " + server)

                    for (const llaveInfoProd in infoProductosArray) {

                        var idProducto = infoProductosArray[llaveInfoProd].id  //el id del producto sacado del archivo json local
                        //console.log(idProducto)
                        var urlNormal = infoProductosArray[llaveInfoProd].url
                        var urlProductos = obtenerUrlConServer(urlNormal, dropdownServidorValue)
                        var urlCrafting = infoProductosArray[llaveInfoProd].urlCrafting
                        var NombreEspañol = infoProductosArray[llaveInfoProd].traduccion
                        var nivelProfesionRequerido = infoProductosArray[llaveInfoProd].nivelUsoProfesion
                        var receta = infoProductosArray[llaveInfoProd].receta
                        var iconProductoBuscado = infoProductosArray[llaveInfoProd].icono
                        var categoria = infoProductosArray[llaveInfoProd].categoria
                        var categoryDefault = infoProductosArray[llaveInfoProd].categoryDefault
                        var expansion = infoProductosArray[llaveInfoProd].expansion
                        var craftingComponent = infoProductosArray[llaveInfoProd].craftingComponentes
                        var nombreUnicoProducto = infoProductosArray[llaveInfoProd].nombreUnico
                        var craftingCategory = infoProductosArray[llaveInfoProd].craftingCategory
                        var productoTooltip = infoProductosArray[llaveInfoProd].tooltipInfo
                        var arrayCraftingFinal = []

                        //Mira si el ID del producto en BD existe dentro del archivo json local
                        if (respuestaArchivoJson.Productos.hasOwnProperty(idProducto) == true) {

                            if (craftingComponent.length != 0) {

                                for (const key in craftingComponent) {
                                    var precioActualPagleComp = craftingComponent[key].precioActualPagle
                                    var precioActualWhitemaneComp = craftingComponent[key].precioActualWhitemane
                                    var itemId = craftingComponent[key].itemId
                                    componenteNombreUnico = craftingComponent[key].nombreUnico
                                    amount = craftingComponent[key].cantidad
                                    var iconoImg = craftingComponent[key].icono
                                    var nombreEnEspañolComp = craftingComponent[key].nombreEnEspañol
                                    var CantidadPorCreacion = craftingComponent[0].cantidadPorCreacion

                                    //mira si el ID del componente existe en el archivo json local
                                    if (respuestaArchivoJson.Productos.hasOwnProperty(itemId)) {
                                        //Nombre del componente encontrado dentro del archivo json
                                        var name = respuestaArchivoJson.Productos[itemId].nombre.toString().toLowerCase()

                                        //precio del componente segun el servidor
                                        if (server == "Pagle") {
                                            precioActualPagleComp = respuestaArchivoJson.Productos[itemId].Precio
                                            precioActualWhitemaneComp = precioActualWhitemaneComp

                                        } else if (server == "Whitemane") {
                                            precioActualWhitemaneComp = respuestaArchivoJson.Productos[itemId].Precio
                                            precioActualPagleComp = precioActualPagleComp
                                        }

                                        //agrega los datos del componente al array
                                        arrayCraftingFinal.push({
                                            "itemId": itemId,
                                            "precioActualPagle": precioActualPagleComp,
                                            "precioActualWhitemane": precioActualWhitemaneComp,
                                            "icono": iconoImg,
                                            "cantidad": amount,
                                            "cantidadPorCreacion": CantidadPorCreacion,
                                            "nombreEnEspañol": name,
                                            "nombreUnico": componenteNombreUnico
                                        })
                                    } else {

                                        //En caso de no encontrar el componente lo deja igual como en la BD
                                        console.log("No se encontró: " + itemId + ", Nombre: " + nombreEnEspañolComp)
                                        arrayCraftingFinal.push({
                                            "itemId": itemId,
                                            "precioActualPagle": precioActualPagleComp,
                                            "precioActualWhitemane": precioActualWhitemaneComp,
                                            "icono": iconoImg,
                                            "cantidad": amount,
                                            "cantidadPorCreacion": CantidadPorCreacion,
                                            "nombreEnEspañol": nombreEnEspañolComp,
                                            "nombreUnico": componenteNombreUnico
                                        })
                                    }
                                }
                            }
                            //console.log(arrayCraftingFinal)
                            //si es pagle o whitemane pone un precio u otro
                            if (server == "Pagle") {
                                try {
                                    //Precio del archivo Local actualizado
                                    precioPagle = respuestaArchivoJson.Productos[idProducto].Precio
                                } catch (error) {
                                    //Se queda con el mismo precio de la BD si no encuentra este producto en el archivo local
                                    precioPagle = infoProductosArray[llaveInfoProd].servidor.pagle.precioActualizado
                                }
                                fechaPagle = respuestaArchivoJson.FechaUltimoScan

                                precioWhitemane = infoProductosArray[llaveInfoProd].servidor.whitemane.precioActualizado
                                fechaWhitemane = infoProductosArray[llaveInfoProd].servidor.whitemane.FechaActualizada

                            } else if (server == "Whitemane") {
                                try {
                                    //Precio del archivo Local actualizado
                                    precioWhitemane = respuestaArchivoJson.Productos[idProducto].Precio
                                } catch (error) {
                                    //Se queda con el mismo precio de la BD si no encuentra este producto en el archivo local
                                    precioWhitemane = infoProductosArray[llaveInfoProd].servidor.whitemane.precioActualizado
                                }
                                fechaWhitemane = respuestaArchivoJson.FechaUltimoScan

                                precioPagle = infoProductosArray[llaveInfoProd].servidor.pagle.precioActualizado
                                fechaPagle = infoProductosArray[llaveInfoProd].servidor.pagle.FechaActualizada

                            }

                            infoProductosActualizadosJson.infoProducts[nombreUnicoProducto] = {
                                "id": idProducto,
                                "url": urlProductos,
                                "traduccion": NombreEspañol,
                                "urlCrafting": urlCrafting,
                                "icono": iconProductoBuscado,
                                "categoria": categoria,
                                "nivelUsoProfesion": nivelProfesionRequerido,
                                "receta": receta,
                                "categoryDefault": categoryDefault,
                                "nombreUnico": nombreUnicoProducto,
                                "craftingCategory": craftingCategory,
                                "tooltipInfo": productoTooltip,
                                "expansion": expansion,
                                "craftingComponentes": arrayCraftingFinal,
                                "servidor": {
                                    "pagle": {
                                        "precioActualizado": precioPagle,
                                        "FechaActualizada": fechaPagle
                                    },
                                    "whitemane": {
                                        "precioActualizado": precioWhitemane,
                                        "FechaActualizada": fechaWhitemane
                                    }
                                }
                            };
                        }

                        //en caso de no encontrarse el id en el archivo local json se queda igual a la BD
                        else {

                            //array de los componentes que ya estan en la base de datos
                            var arrayCrafteoEnBD = infoProductosArray[llaveInfoProd].craftingComponentes

                            //Conserva el mismo precio y fecha de pagle y whitemane de la BD
                            var precioPagle = infoProductosArray[llaveInfoProd].servidor.pagle.precioActualizado
                            var fechaPagle = infoProductosArray[llaveInfoProd].servidor.pagle.FechaActualizada

                            var precioWhitemane = infoProductosArray[llaveInfoProd].servidor.whitemane.precioActualizado
                            var fechaWhitemane = infoProductosArray[llaveInfoProd].servidor.whitemane.FechaActualizada

                            infoProductosActualizadosJson.infoProducts[nombreUnicoProducto] = {
                                "id": idProducto,
                                "url": urlProductos,
                                "traduccion": NombreEspañol,
                                "urlCrafting": urlCrafting,
                                "icono": iconProductoBuscado,
                                "categoria": categoria,
                                "nivelUsoProfesion": nivelProfesionRequerido,
                                "receta": receta,
                                "categoryDefault": categoryDefault,
                                "nombreUnico": nombreUnicoProducto,
                                "craftingCategory": craftingCategory,
                                "tooltipInfo": productoTooltip,
                                "expansion": expansion,
                                "craftingComponentes": arrayCrafteoEnBD,
                                "servidor": {
                                    "pagle": {
                                        "precioActualizado": precioPagle,
                                        "FechaActualizada": fechaPagle
                                    },
                                    "whitemane": {
                                        "precioActualizado": precioWhitemane,
                                        "FechaActualizada": fechaWhitemane
                                    }
                                }
                            };
                        }
                    }

                    console.log("Nueva lista creada (3/4)")
                    console.log(infoProductosActualizadosJson)
                    //console.log("Modo seguro")

                    //Ahora lo subimos a firestore
                    await setDoc(doc(db, "data", "datos"), infoProductosActualizadosJson).then(resp => {

                        console.log("Se han guardado los datos (4/4)")
                        alert("Agregado correctamente!")
                        window.location.reload(true);
                    }).catch(function (reason) {
                        console.log(reason)

                    });
                    break
                } catch (error) {
                    console.log(error)
                    if (indice == 4) {
                        toastr.error("Error al subir el archivo local, intentelo de nuevo!", "Mensaje")
                    }
                }
            }

        }

        //funcion cuando se selecciona el radio de nexus
        function CheckNexusSelected() {
            RadioValorSelected = RadioNexusVar.value
            btnSubir.style.visibility = "hidden";
            if (ladoDelTabId == 0) {
                SeleccionListaCategoriaCrafteo()
            } else if (ladoDelTabId == 1) {
                SeleccionListaServidor()
            }
        }

        //funcion cuando se selecciona el radio local
        function CheckArchivoSelected() {
            var RadioArchivoValor = RadioArchivo.value
            btnSubir.style.visibility = "visible";
            if (ladoDelTabId == 0) {
                SeleccionListaCategoriaCrafteo()
            } else if (ladoDelTabId == 1) {
                SeleccionListaServidor()
            }
        }

        //Funcion que sube el archivo a Filestack y obtiene su URL
        function subirArchivoJson() {
            var urlJsonSubido = ""

            const client = filestack.init("AQacciKSRQgKSUJl2BTpFz");
            const options = {
                uploadConfig: {
                    retry: 5,
                    timeout: 65000,
                },
                onFileUploadFinished: file => {
                    //Cuando termina de subir el archivo se obtiene la respuesta aquí
                    urlJsonSubido = file.url
                    leerJsonSubido(urlJsonSubido)
                    console.log("El archivo se ah subido! (1/4)")
                    console.log("Url: " + urlJsonSubido)
                }
            };
            //Abre el subidor de archivos
            var oro = client.picker(options).open()
        }

        //pone los numero en 0 como plata si no lo deja en oro
        function PlataOro(nro) {

            var PrecioFloat = nro
            if (PrecioFloat > 1) {
                //si es positivo y es oro
                var precioMinimo = parseFloat(PrecioFloat).toFixed(2) + " Oro"
                positivoNegativo = true

            } else if (PrecioFloat > 0.01) {
                //si es positivo y es plata
                var precioMinimo = parseFloat(PrecioFloat).toFixed(4) * 100 + " Plata"
                var precioMin = precioMinimo.split(" ")
                if (precioMin[0] == 100) {
                    precioMinimo = PrecioFloat + " Oro"
                }
                positivoNegativo = true

            } else if (PrecioFloat < 0.01 && PrecioFloat > 0.0001) {
                //si es positivo y es cobre
                var precioMinimo = PrecioFloat * 10000 + " Cobre"
                positivoNegativo = true
            } else {
                //aqui esto es negativo
                precioMinimo = PrecioFloat * 100
                positivoNegativo = false

                if (precioMinimo < -100) {
                    //si esto es negativo y pasa de -100
                    var precioMinimo = parseFloat(precioMinimo / 100).toFixed(2) + " Oro"

                } else {
                    //si esto es negativo y es menor a -100
                    var precioMinimo = PrecioFloat * 100 + " Plata"
                }
            }
            return precioMinimo;
        }

        //igual que la anterior pero sin poner el texto de oro plata o cobre
        function PlataOroEspecial(nro) {

            var PrecioFloat = nro
            if (PrecioFloat > 1) {
                //si es positivo y es oro
                var precioMinimo = parseFloat(PrecioFloat).toFixed(2)

            } else if (PrecioFloat > 0.01) {
                //si es positivo y es plata
                var precioMinimo = parseFloat(PrecioFloat).toFixed(4) * 100
                var precioMin = precioMinimo.toString().split(" ")
                if (parseInt(precioMin[0]) == 100) {
                    precioMinimo = PrecioFloat
                }
                positivoNegativo = true

            } else if (PrecioFloat > 0.001) {
                //si es positivo y es cobre
                var precioMinimo = PrecioFloat * 10000
                positivoNegativo = true
            } else {
                //aqui esto es negativo
                precioMinimo = PrecioFloat * 100
                positivoNegativo = false

                if (precioMinimo < -100) {
                    //si esto es negativo y pasa de -100
                    var precioMinimo = parseFloat(precioMinimo / 100).toFixed(2)

                } else {
                    //si esto es negativo y es menor a -100
                    var precioMinimo = PrecioFloat * 100
                }
            }
            return precioMinimo;
        }

        //Dice la ganancia si se publica al precio promedio
        function gananciaPromedia(preMinimo, prePromedio) {
            var calculoDelCincoPorcieto = prePromedio * 5 / 100
            var SaldoMenosCincoPorciento = prePromedio - calculoDelCincoPorcieto
            var gananciaEstimada = SaldoMenosCincoPorciento - preMinimo
            return gananciaEstimada;
        }

        //Limpia la tabla
        function LimpiarTabla() {
            var tableHeaderRowCount = 1;
            var table = document.getElementById('productos');
            var rowCount = table.rows.length;
            for (var i = tableHeaderRowCount; i < rowCount; i++) {
                table.deleteRow(tableHeaderRowCount);
            }
        }

        //Limpia la tabla crafting
        function LimpiarTablaCrafting() {
            var tableHeaderRowCount = 1;
            var table = document.getElementById('crafteoTabla');
            var rowCount = table.rows.length;
            for (var i = tableHeaderRowCount; i < rowCount; i++) {
                table.deleteRow(tableHeaderRowCount);
            }
        }

        //Limpia la tabla componentes
        function LimpiarTablaComponentes() {
            var tableHeaderRowCount = 1;
            var table = document.getElementById('tablaComponentes');
            var rowCount = table.rows.length;
            for (var i = tableHeaderRowCount; i < rowCount; i++) {
                table.deleteRow(tableHeaderRowCount);
            }
        }

        //traduce el mes a español
        function mesEnEspañol(mesIngles) {
            var mesEspañol = ""

            if (mesIngles == "Jan") {
                mesEspañol = "Enero"
            } else if (mesIngles == "Feb") {
                mesEspañol = "Febrero"
            } else if (mesIngles == "Mar") {
                mesEspañol = "Marzo"
            } else if (mesIngles == "Apr") {
                mesEspañol = "Abril"
            } else if (mesIngles == "May") {
                mesEspañol = "Mayo"
            } else if (mesIngles == "Jun") {
                mesEspañol = "Junio"
            } else if (mesIngles == "Jul") {
                mesEspañol = "Julio"
            } else if (mesIngles == "Aug") {
                mesEspañol = "Agosto"
            } else if (mesIngles == "Sep") {
                mesEspañol = "Septiembre"
            } else if (mesIngles == "Oct") {
                mesEspañol = "Octubre"
            } else if (mesIngles == "Nov") {
                mesEspañol = "Noviembre"
            } else if (mesIngles == "Dec") {
                mesEspañol = "Diciembre"
            }
            return mesEspañol
        }

        function lastUpdatedModalComp(fechaActual) {

            const d = new Date(fechaActual * 1000);
            var Dia = d.toString().split(" ")[2]
            var Mes = mesEnEspañol(d.toString().split(" ")[1])
            var Año = d.toString().split(" ")[3]
            var fechaCompleta = "Fecha: " + Dia + " de " + Mes + " del " + Año

            var hora = hora24a12(d.getHours())
            var minuto = minutosConCero(d.getMinutes())
            var ultimoScanHora = "- Último escaneo: " + hora[0] + ":" + minuto + " " + hora[1]

            var escaneo = ultimoScanHora + " - " + fechaCompleta;

            fechaEnModal = escaneo
            return fechaEnModal;
        }

        //Fecha de la ultima actualización
        async function lastUpdated(fechaActual) {
            for (let count = 0; count < 5; count++) {

                try {
                    var fechaParaRetornar = 0

                    //Si el proveeedor es del archivo pone la fecha del archivo
                    if (RadioValorSelected == "radioLocalJson") {
                        const d = new Date(fechaActual * 1000);
                        var Dia = d.toString().split(" ")[2]
                        var Mes = mesEnEspañol(d.toString().split(" ")[1])
                        var Año = d.toString().split(" ")[3]
                        var fechaCompleta = "Fecha: " + Dia + " de " + Mes + " del " + Año

                        var hora = hora24a12(d.getHours())
                        var minuto = minutosConCero(d.getMinutes())
                        var ultimoScanHora = "- Último escaneo: " + hora[0] + ":" + minuto + " " + hora[1]

                        var escaneo = document.getElementById("lastUpdated").innerHTML = ultimoScanHora + " - " + fechaCompleta;

                        fechaEnModal = hora[0] + ":" + minuto + " " + hora[1] + " - " + fechaCompleta;

                    } else if (RadioValorSelected == "radioNexus") {

                        //si el proveedor es de nexus entonces usa esa fecha
                        var corsurl = "https://api.codetabs.com/v1/proxy?quest="
                        const respuesta = await fetch(corsurl + "https://api.nexushub.co/wow-classic/v1/items/pagle-alliance/scroll-of-agility-iv")
                        const jsonResultado = await respuesta.json()

                        const d = new Date(jsonResultado.stats.lastUpdated);
                        var Dia = d.toString().split(" ")[2]
                        var Mes = mesEnEspañol(d.toString().split(" ")[1])
                        var Año = d.toString().split(" ")[3]
                        var fechaCompleta = "Fecha: " + Dia + " de " + Mes + " del " + Año
                        var fechaAqui = "Fecha: " + Dia + " de " + Mes + " del " + Año

                        var hora = hora24a12(d.getHours())
                        var minuto = minutosConCero(d.getMinutes())
                        var ultimoScanHora = "- Último escaneo: " + hora[0] + ":" + minuto + " " + hora[1]

                        var escaneo = document.getElementById("lastUpdated").innerHTML = ultimoScanHora + " - " + fechaCompleta;
                    }
                    break
                } catch (error) {
                    if (count == 5) {
                        break
                    }
                    console.log(error)
                    sleep(1000)
                }
            }
        }

        function minutosConCero(min) {
            var minuto = ""
            if (min == 1) {
                minuto = "0"
            } else if (min == 2) {
                minuto = "02"
            } else if (min == 3) {
                minuto = "03"
            } else if (min == 2) {
                minuto = "04"
            } else if (min == 4) {
                minuto = "05"
            } else if (min == 5) {
                minuto = "05"
            } else if (min == 6) {
                minuto = "06"
            } else if (min == 7) {
                minuto = "07"
            } else if (min == 8) {
                minuto = "08"
            } else if (min == 9) {
                minuto = "09"
            } else if (min == 0) {
                minuto = "00"
            } else {
                minuto = min
            }
            return minuto
        }
        //sugiere comprar hasta el 15% si la ganancia es mayor al 20%
        function CompraMaxima(prePromedio, porcentajeGanancia) {

            var porcentajeEsperado = 20
            if (porcentajeGanancia >= porcentajeEsperado) {

                var calculoDelCincoPorcieto1 = prePromedio * 5 / 100
                var SaldoPromedioMenosCincoPorciento = prePromedio - calculoDelCincoPorcieto1
                //
                var saldoCompraHasta15 = SaldoPromedioMenosCincoPorciento * 0.85
            } else {
                var saldoCompraHasta15 = "-"
            }

            return saldoCompraHasta15

        }

        //sleep
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        //Cambia el horario 24 horas a 12 horas.
        function hora24a12(hora) {
            if (hora == 12) {
                hora = [12, "pm"]
            } else if (hora == 13) {
                hora = [1, "pm"]
            } else if (hora == 14) {
                hora = [2, "pm"]
            } else if (hora == 15) {
                hora = [3, "pm"]
            } else if (hora == 16) {
                hora = [4, "pm"]
            } else if (hora == 17) {
                hora = [5, "pm"]
            } else if (hora == 18) {
                hora = [6, "pm"]
            } else if (hora == 19) {
                hora = [7, "pm"]
            } else if (hora == 20) {
                hora = [8, "pm"]
            } else if (hora == 21) {
                hora = [9, "pm"]
            } else if (hora == 22) {
                hora = [10, "pm"]
            } else if (hora == 23) {
                hora = [11, "pm"]
            } else if (hora == 24) {
                hora = [12, "am"]
            } else if (hora == 0) {
                hora = [12, "am"]
            } else {
                hora = [hora, "am"]
            }
            return hora;
        }

        //ordena la tabla de mayor a menor
        function compareValues(a, b) {
            // return -1/0/1 based on what you "know" a and b
            // are here. Numbers, text, some custom case-insensitive
            // and natural number ordering, etc. That's up to you.
            // A typical "do whatever JS would do" is:
            a = parseFloat(a.split(" ")[0])
            b = parseFloat(b.split(" ")[0])
            return (a > b) ? -1 : (a < b) ? 1 : 0;
        }

        function sortTable() {
            var tbody = tablaProducto.querySelector(`tbody`);
            var rows = Array.from(tablaProducto.querySelectorAll(`tr`));
            // but ignore the heading row:
            rows = rows.slice(1);
            var posicion = 8
            // set up the queryselector for getting the indicated
            // column from a row, so we can compare using its value:
            var qs = `td:nth-child(${posicion})`;
            // and then just... sort the rows:
            rows.sort((r1, r2) => {
                // get each row's relevant column
                var t2 = r2.querySelector(qs);
                var t1 = r1.querySelector(qs);
                // and then effect sorting by comparing their content:
                return compareValues(t1.textContent, t2.textContent);
            });

            // and then the magic part that makes the sorting appear on-page:
            rows.forEach(row => tbody.appendChild(row));
        }

        function sortTableCrafting() {
            var tbody = tablaCrafting.querySelector(`tbody`);
            var rows = Array.from(tablaCrafting.querySelectorAll(`tr`));
            // but ignore the heading row:
            rows = rows.slice(1);
            var posicion = 7
            // set up the queryselector for getting the indicated
            // column from a row, so we can compare using its value:
            var qs = `td:nth-child(${posicion})`;
            // and then just... sort the rows:
            rows.sort((r1, r2) => {
                // get each row's relevant column
                var t2 = r2.querySelector(qs);
                var t1 = r1.querySelector(qs);
                // and then effect sorting by comparing their content:
                return compareValues(t1.textContent, t2.textContent);
            });

            // and then the magic part that makes the sorting appear on-page:
            rows.forEach(row => tbody.appendChild(row));
        }

        //******************************* JS DE LA VENTANA **********************************

        //funcion que solicita los datos del url
        async function SolicitarDatos(precioDeVentaEnTablaNro, tipoMonedaOroPlataBronce, uniqueName) {

            if (tipoMonedaOroPlataBronce == "Oro") {
                precioDeVentaEnTablaNro = precioDeVentaEnTablaNro * 10000
            } else if (tipoMonedaOroPlataBronce == "Plata") {
                precioDeVentaEnTablaNro = precioDeVentaEnTablaNro * 100

            } else if (tipoMonedaOroPlataBronce == "Cobre") {
                precioDeVentaEnTablaNro = precioDeVentaEnTablaNro * 10
            }

            LimpiarTablaVerificacion()

            var Url = "https://api.nexushub.co/wow-classic/v1/items/pagle-alliance/" + uniqueName + "/prices"
            const respuesta = await fetch(corsurl + Url)
            const jsonResultado = await respuesta.json()

            //pone el ID a las graficas del modal que se este abriendo flipping o crafting
            divCharFlippng.id = "chart"
            divCharCrafting.id = "SinUso"
            //trae los datos del historia de 7 dias para ponerlos en la gráfica
            modalVisible = true
            obtenerDatosDeGrafica(Url)

            for (var index = 0; index < jsonResultado.data.length; index++) {

                const d = new Date(jsonResultado.data[index].scannedAt);
                var hora = hora24a12(d.getHours())
                var minuto = minutosConCero(d.getMinutes())
                var horaMinutos = hora[0] + ":" + minuto + " " + hora[1]
                var diaSemana = d.toString().split(" ")[0]
                var precioCompra = jsonResultado.data[index].minBuyout

                if (precioCompra > precioDeVentaEnTablaNro) {
                    //verifica si el dia de la semana es el mismo o ha cambiado
                    if (diaSemana == diaSemanaAnterior) {
                        //en caso que sea el mismo dia
                        cantidades = cantidades + 1
                        diaSemanaAnterior = diaSemana
                        precioCompra = PlataOro(precioCompra / 10000)
                        crearColumna(diaSemana, cantidades, precioCompra, horaMinutos)

                    } else {
                        //cuando cambia a otro dia de la semana
                        cantidades = 1
                        diaSemanaAnterior = diaSemana
                        precioCompra = PlataOro(precioCompra / 10000)
                        crearColumna(diaSemana, cantidades, precioCompra, horaMinutos)
                    }
                }
            }

        }

        //funcion que crea las columnas de la tabla
        function crearColumna(diaSemana, cantidades, precioCompra, Hora) {

            //crea un TR
            var fila = document.createElement('tr');

            //agrega la columna Día
            var td = document.createElement('td');
            td.innerText = TraducirDiaSemana(diaSemana)
            td.setAttribute("style", "font-weight:bold");
            fila.appendChild(td);

            //agrega la columna #
            td = document.createElement('td');
            td.innerText = cantidades
            td.setAttribute("style", "font-weight:bold");
            fila.appendChild(td);
            tbody.appendChild(fila);

            //agrega la columna Precio Compra
            td = document.createElement('td');
            td.innerText = precioCompra
            td.setAttribute("style", "font-weight:bold");
            fila.appendChild(td);
            tbody.appendChild(fila);

            //agrega la columna Hora
            td = document.createElement('td');
            td.innerText = Hora
            td.setAttribute("style", "font-weight:bold");
            fila.appendChild(td);
            tbody.appendChild(fila);
        }

        //funcion que crea las columnas de la tabla
        function crearColumnaEnComp(diaSemana, cantidades, precioCompra, Hora) {

            //crea un TR
            var fila = document.createElement('tr');

            //agrega la columna Día
            var td = document.createElement('td');
            td.innerText = TraducirDiaSemana(diaSemana)
            td.setAttribute("style", "font-weight:bold");
            fila.appendChild(td);

            //agrega la columna #
            td = document.createElement('td');
            td.innerText = cantidades
            td.setAttribute("style", "font-weight:bold");
            fila.appendChild(td);

            //agrega la columna Precio Compra
            td = document.createElement('td');
            td.innerText = precioCompra
            td.setAttribute("style", "font-weight:bold");
            fila.appendChild(td);

            //agrega la columna Hora
            td = document.createElement('td');
            td.innerText = Hora
            td.setAttribute("style", "font-weight:bold");
            fila.appendChild(td);
            cuerpoTablaDiasVentaEnComp.appendChild(fila);
        }


        //el Boton para hacer una nueva verificacion con otro precio de venta
        function cambiarPrecioVntaBtn() {
            campoTextprecioDeVentaID = document.getElementById("PventaId")
            campoTextprecioDeVentaID = campoTextprecioDeVentaID.value
            SolicitarDatos(campoTextprecioDeVentaID, tipoMonedaOroPlataBronce, nombreUnico)
        }

        //el Boton para hacer una nueva verificacion con otro precio de venta en componentes
        function cambiarPrecioVntaBtnComp() {
            vieneDeClickBtnCambiarEnComp = true
            SolicitarDatosDiaDeVentaCrafteo()
        }

        //Limpia la tabla en Flipping dias de venta
        function LimpiarTablaVerificacion() {
            var tableHeaderRowCount = 1;
            var table = document.getElementById('tablaVerificacion');
            var rowCount = table.rows.length;
            for (var i = tableHeaderRowCount; i < rowCount; i++) {
                table.deleteRow(tableHeaderRowCount);
            }
        }

        //Limpia la tabla en Componentes dias de venta
        function LimpiarTablaVerificacionEnComp() {
            var tableHeaderRowCount = 1;
            cantidades = 0
            var table = tablaDiasVentaComp
            var rowCount = table.rows.length;
            for (var i = tableHeaderRowCount; i < rowCount; i++) {
                table.deleteRow(tableHeaderRowCount);
            }
        }

        //obtiene el url con el server seleccionado del dropdown
        function obtenerUrlConServer(urlNormal, serverSelected) {
            var urlSplit = urlNormal.split("/")
            var serverFaccionSplit = urlSplit[6].toString().split("-")
            var urlProductosConServerSelect = urlSplit[0] + "//" + urlSplit[2] + "/" + urlSplit[3] + "/" + urlSplit[4] + "/" + urlSplit[5] + "/" + serverSelected + "/" + urlSplit[7]
            return urlProductosConServerSelect
        }

        //obtiene el url con el server seleccionado del dropdown
        function obtenerUrlCrafteo(urlNormal, serverSelected) {
            var urlSplit = urlNormal.split("/")
            var serverFaccionSplit = urlSplit[6].toString().split("-")
            var urlProductosConServerSelect = urlSplit[0] + "//" + urlSplit[2] + "/" + urlSplit[3] + "/" + urlSplit[4] + "/crafting/" + serverSelected + "/" + urlSplit[7]
            return urlProductosConServerSelect
        }

        //traduccion de dia de la semana
        function TraducirDiaSemana(diaSemana) {
            if (diaSemana == "Mon") {
                diaSemana = "Lunes"
            } else if (diaSemana == "Tue") {
                diaSemana = "Martes"
            } else if (diaSemana == "Wed") {
                diaSemana = "Miercoles"
            } else if (diaSemana == "Thu") {
                diaSemana = "Jueves"
            } else if (diaSemana == "Fri") {
                diaSemana = "Viernes"
            } else if (diaSemana == "Sat") {
                diaSemana = "Sabado"
            } else if (diaSemana == "Sun") {
                diaSemana = "Domingo"
            }

            return diaSemana;
        }

        //copia el nombre del producto al que se le da doble click
        function copiarNombreProducto(NombreEspañol) {
            // Copia el nombre del producto
            navigator.clipboard.writeText(NombreEspañol);
            toastr.success(NombreEspañol, "Nombre copiado: ")
        }

        //pone el precio de vial del npc y no el de subasta
        function vialPriceNpc(nameVial) {
            var vialPrice = 0
            if (nameVial == "vial imbuido") {
                vialPrice = 19000 / 10000
                vialPrice = vialPrice / 5
            } else if (nameVial == "vial vacío") {
                vialPrice = 19 / 10000
                vialPrice = vialPrice / 5
            } else if (nameVial == "vial emplomado") {
                vialPrice = 190 / 10000
                vialPrice = vialPrice / 5
            } else if (nameVial == "vial de cristal") {
                vialPrice = 2300 / 10000
                vialPrice = vialPrice / 5
            } else if (nameVial == "vial encantado") {
                vialPrice = 47500 / 10000
                vialPrice = vialPrice / 5
            }
            return vialPrice;
        }


        //Pone el preco de los papiros de inscripcion al de NPC
        function papiroPriceNpc(papiroName) {
            var papiroPrice = 0
            if (papiroName == "papiro ligero") {
                papiroPrice = 14 / 10000
                console.log(papiroPrice)
            } else if (papiroName == "papiro en blanco") {
                papiroPrice = 119 / 10000
            } else if (papiroName == "papiro pesado") {
                papiroPrice = 1188 / 10000
            } else if (papiroName == "papiro resilente") {
                papiroPrice = 4750 / 10000
            } else if (papiroName == "papiro común") {
                papiroPrice = 119 / 10000
            }
            return papiroPrice;
        }

        //Trae la data de 7 dias para imprimirla en la grafica
        async function obtenerDatosDeGrafica(urlDatosDeGrafica) {
            var arrayPrecioEnGrafica = []
            var arrayCantidadEnGrafica = []
            var arrayFechaEnGrafica = []
            var colorPrecioGrafica = "#7fff00"
            var colorCantidadFrafica = "#0088d6"

            for (let index = 0; index < 4; index++) {
                try {
                    //Consulta el historial de precio de  dias
                    const respuesta = await fetch(corsurl + urlDatosDeGrafica)
                    const json = await respuesta.json()

                    //habilita la tab de Días de venta si ya está cargado los datos de la gráfica
                    document.getElementById("DiaDeVentaTabIdComp").disabled = false;

                    nameunicoDeProductoEnGrafic = json.uniqueName // nombre unico del producto del modal comp
                    jsonDeSieteDiazHistorico = json // json de historial de 7 dias

                    for (const key in json.data) {
                        var precioMinimo = parseInt(json.data[key].minBuyout) / 10000
                        var cantidadPublicada = json.data[key].quantity
                        var fechaDePublicacion = json.data[key].scannedAt


                        //Pone los datos en un array
                        arrayPrecioEnGrafica.push(precioMinimo)
                        arrayCantidadEnGrafica.push(cantidadPublicada)
                        arrayFechaEnGrafica.push(fechaDePublicacion)
                    }

                    //imprime los datos en la grafica
                    var options = {
                        series: [{
                            name: "Precio",
                            data: arrayPrecioEnGrafica
                        },
                        {
                            name: "Cantidad",
                            data: arrayCantidadEnGrafica
                        }],
                        labels: arrayFechaEnGrafica,
                        chart: {
                            height: 350,
                            type: 'line',
                            foreColor: "#ffe4c4",
                            events: {
                                Mounted: function (chartContext, config) {
                                    if (modalVisible == false) {
                                        console.log("Montado desde el evento Mounted")
                                        chart.clearAnnotations()
                                        chart.destroy()
                                        console.log("Destruido desde el event Mounted")
                                    }
                                }
                            }
                        },
                        stroke: {
                            width: [2.5, 2.5]
                        },
                        colors: [colorPrecioGrafica, colorCantidadFrafica],
                        title: {
                            text: 'Gráfico de precio y cantidad',
                        },
                        noData: {
                            text: 'Cargando datos...'
                        },

                        xaxis: {
                            type: 'datetime',
                        },
                        yaxis: [
                            {
                                axisTicks: {
                                    show: true
                                },
                                axisBorder: {
                                    show: true,
                                    color: colorPrecioGrafica
                                },
                                labels: {
                                    style: {
                                        colors: colorPrecioGrafica
                                    }
                                },

                            },
                            {
                                opposite: true,
                                axisTicks: {
                                    show: true
                                },
                                axisBorder: {
                                    show: true,
                                    color: colorCantidadFrafica
                                },
                                labels: {
                                    style: {
                                        colors: colorCantidadFrafica
                                    }
                                },

                            }
                        ]
                    };
                    //Destruye algun chart si esta vivo aun
                    try {
                        chart.clearAnnotations()
                        chart.destroy()
                        //console.log("destruido")
                    } catch (error) {
                        //console.log("No hay chart vivos")
                    }

                    chart = new ApexCharts(document.querySelector("#chart"), options);
                    chart.render();
                    break
                } catch (error) {
                    console.log(error)
                }

            }
        }
    </script>
</body>

</html>