<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agregar items</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!--jquery 3-->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css">
</head>

<body>

    <style>
        h2 {
            color: darkgoldenrod;
        }

        label {
            color: bisque;
        }

        body {
            background-image: url("https://images4.alphacoders.com/801/thumb-1920-80134.jpg");
            background-repeat: no-repeat;
        }

        #divFormId {
            margin-left: 20px;
            margin-right: 20px;
        }

        #div2 {
            width: 500px;
            margin-top: 20px;
            padding-top: 10px;
            border-radius: 15px;
            box-shadow: 0px 0px 10px 5px rgba(107, 107, 107, 0.2);
            background-color: #242424;
            opacity: 0.90;
        }

        #buscarLabed {
            margin-left: 45px;
        }
    </style>

    <div id="divParent" class="container d-flex justify-content-center ">

        <div id="div2" class="">
            <div class="d-flex justify-content-center ">
                <h2>Agregador de Productos</h2>
            </div><br>

            <div id="divFormId">
                <form>
                    <div class="form-group ">
                        <div>

                            <label id="buscarLabed" for="inputAddress">Buscar producto:</label>
                        </div>
                        <div class="form-group d-flex justify-content-center">
                            <input id="inputTxtBusquedaId" class="col-md-8" type="text"
                                placeholder="Ejemp: Barra de torio">
                            <button id="btnBuscar" class="btn btn-primary" type="button">
                                <span class="col-md-4 spinner-grow spinner-grow-sm" role="status"
                                    aria-hidden="true"></span>
                                Buscar
                            </button>

                        </div>
                        <div class="form-group col-md-12">
                            <select id="selectBusqueda" class="form-control">
                            </select>
                        </div>

                        <div class="form-group col-md-12">
                            <label for="inputAddress2">Categoría:</label>
                            <select id="selectCategoria" class="form-control">
                            </select>
                        </div>
                        <div class="form-group col-md-12">
                            <label for="inputAddress2">Categoría de crafting</label>
                            <select id="selectCategoriaCrafting" class="form-control">
                            </select>
                        </div>
                        <div class="form-group col-md-12">
                            <label for="inputAddress2">Expansion:</label>
                            <select id="selectExpansion" class="form-control">
                                <option selected>Classic</option>
                                <option selected>Tbc</option>
                                <option selected>Wotlk</option>
                            </select>
                            <br>
                </form>
            </div>

            <div class="d-flex p-2 justify-content-center">
                <input type="button" id="btnAgregar" class="btn btn-primary" value="Agregar"></button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.9.2/firebase-app.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/9.9.2/firebase-firestore.js"
        import { collection, getDocs, addDoc, doc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.9.2/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB4a33fFr6SgUAXjZ6FeFB_XDGL6SKuCuY",
            authDomain: "wowprices-74a82.firebaseapp.com",
            projectId: "wowprices-74a82",
            storageBucket: "wowprices-74a82.appspot.com",
            messagingSenderId: "380944707410",
            appId: "1:380944707410:web:2f229f9fbf99d96e39148b"
        };

        const app = initializeApp(firebaseConfig);

        var infoProductosArray = []
        var campoTraduccion = document.getElementById("campoTraduccion")
        var campoUnicoNombre = document.getElementById("campoUnicoNombre")
        var campoCategoria = document.getElementById("campoCategoria")
        var selectCategoria = document.getElementById("selectCategoria")
        var selectCategoriaCrafting = document.getElementById("selectCategoriaCrafting")
        var selectExpansion = document.getElementById("selectExpansion")
        var productBusqueda = document.getElementById('selectBusqueda');
        var inputTxtDeBusqueda = document.getElementById("inputTxtBusquedaId")
        var unicoNombre = ""

        //variables nuevas
        var btnBuscar = document.getElementById("btnBuscar")
        var corsurl = "https://api.codetabs.com/v1/proxy?quest="
        var urlBusquedaWowHeadEspañol = "https://es.tbc.wowhead.com/search/suggestions-template?q="
        var urlNexusProducto = "https://api.nexushub.co/wow-classic/v1/items/pagle-alliance/"
        var urlNexusCrafting = "https://api.nexushub.co/wow-classic/v1/crafting/pagle-alliance/"
        var nombreConGuion = ""
        var arrayComponentes = []
        var arrayProductoBuscado = []
        var arrayCraftingFinal = []

        leerDatos()

        document.getElementById('btnAgregar').addEventListener('click', function () {
            //agregarProducto()
            var NameClickedEspañol = productBusqueda.value
            for (const key in arrayProductoBuscado) {
                if (arrayProductoBuscado[key].name == NameClickedEspañol) {

                    var id = arrayProductoBuscado[key].id
                    console.log(NameClickedEspañol)
                    var urlNexusProductoAqui = urlNexusProducto + id
                    var urlNexusCraftingAqui = urlNexusCrafting + id
                    buscarProductoEnNexus(urlNexusProductoAqui, urlNexusCraftingAqui, NameClickedEspañol)
                }
            }
        });

        document.getElementById('btnBuscar').addEventListener('click', function () {
            buscaObjeto()
        });


        async function leerDatos() {
            // Inicializa Firebase si no esta inicializado
            if (!firebase.apps.length) {
                const app = initializeApp(firebaseConfig);
            }
            const db = getFirestore(app);
            const colRef = collection(db, "data");
            const docsSnap = await getDocs(colRef);
            docsSnap.forEach(doc => {

                //agrega las categorias al dropdown
                for (const key in doc.data().tipo) {
                    const element = doc.data().tipo[key];
                    var daySelect = document.getElementById('selectCategoria');
                    daySelect.options[daySelect.options.length] = new Option(element, element);
                }

                //agrega las categorias de crafting al dropdown
                for (const key in doc.data().crafting) {
                    const elementCate = doc.data().crafting[key];
                    var crafCategory = document.getElementById('selectCategoriaCrafting');
                    crafCategory.options[crafCategory.options.length] = new Option(elementCate, elementCate);
                }

                //guarda el json de los productos agregados
                for (const key in doc.data().infoProducts) {
                    //console.log(doc.data().infoProducts[key])
                    infoProductosArray.push(doc.data().infoProducts[key])
                }
            })
            //console.log(infoProductosArray)
        }

        async function agregarProducto(urlNexusProducto, urlNexusCrafting, nombreEspañol, nombreConGuion, arrayComponentes) {
            // Inicializa Firebase si no esta inicializado
            if (!firebase.apps.length) {
                const app = initializeApp(firebaseConfig);
            }
            var indicadorDeEnvio = true
            const db = getFirestore(app);
            // var urlDelProducto = "https://api.nexushub.co/wow-classic/v1/items/pagle-alliance/" + campoUnicoNombre.value

            //Comprobamos el url del producto ya esta en la base de datos
            for (var index = 0; index < infoProductosArray.length; index++) {
                if (infoProductosArray[index].url == urlNexusProducto) {
                    indicadorDeEnvio = false
                    console.log("este producto ya existe : " + urlNexusProducto)
                    alert("Este producto ya EXISTE!")
                    break
                }
            }

            for (const key in arrayComponentes) {
                var itemId = arrayComponentes[key].itemId
                var componenteNombreUnico = arrayComponentes[key].uniqueName
                var amount = arrayComponentes[key].amount
                arrayCraftingFinal.push({
                    "itemId": itemId,
                    "precioActual": 0,
                    "cantidad": amount,
                    "nombreUnico": componenteNombreUnico
                })
            }

            if (indicadorDeEnvio == true) {
                console.log("Agregando los productos...")

                //Si no existen el url del producto se procede a enviar el nuevo producto
                unicoNombre = nombreConGuion
                await setDoc(doc(db, "data", "datos"), {
                    "infoProducts": {
                        [unicoNombre]: {
                            "url": urlNexusProducto,
                            "urlCrafting": urlNexusCrafting,
                            "traduccion": nombreEspañol,
                            "categoria": selectCategoria.value,
                            "nombreUnico": unicoNombre,
                            "expansion": selectExpansion.value,
                            "craftingCategory": selectCategoriaCrafting.value,
                            "craftingComponentes": arrayCraftingFinal,
                            "servidor": {
                                "pagle": {
                                    "precioActualizado": 0,
                                    "FechaActualizada": 0
                                },
                                "whitemane": {
                                    "precioActualizado": 0,
                                    "FechaActualizada": 0
                                }
                            }
                        }
                    }
                }, { merge: true }).then(resp => {
                    console.log("Se han guardado los datos")
                    //Luego de guardar los datos limpiamos los campos de texto

                    inputTxtDeBusqueda.value = ""
                    $("selectBusqueda").empty();
                    alert("Agregado correctamente!")
                }).catch(function (reason) {
                    console.log(reason)
                    alert("Hay campos vacíos, debe llenarlos todos antes de enviar.")
                });


            }
        }

        async function buscaObjeto() {
            $(productBusqueda).empty();
            var nombreEspañolProducto = inputTxtDeBusqueda.value
            const respuesta = await fetch(corsurl + urlBusquedaWowHeadEspañol + nombreEspañolProducto)
            const json = await respuesta.json()

            //recorre el json que da el url de busqueda de wowhead
            for (const key in json.results) {
                var tipo = json.results[key].typeName
                var name = json.results[key].name


                //si la busqueda es un objeto
                if (tipo === "Objeto") {

                    //agrega la busqueda al dropdown
                    const elementCate = name
                    console.log(elementCate)
                    productBusqueda.options[productBusqueda.options.length] = new Option(elementCate, elementCate);

                    arrayProductoBuscado.push(json.results[key])

                }
            }
        }

        async function buscarProductoEnNexus(urlNexusProducto, urlNexusCrafting, nombreEspañol) {
            Promise.all([
                fetch(urlNexusProducto),
                fetch(urlNexusCrafting)
            ]).then(async ([aa, bb]) => {
                const a = await aa.json();
                const b = await bb.json();
                return [a, b]
            })
                .then((responseText) => {
                    nombreConGuion = responseText[0].uniqueName
                    console.log(nombreConGuion)
                    try {

                        arrayComponentes = responseText[1].createdBy[0].reagents
                    } catch (error) {
                        arrayComponentes["n/a"]
                    }
                    console.log(arrayComponentes);
                    console.log("url: " + urlNexusProducto)
                    console.log("urlCrafting: " + urlNexusCrafting)
                    console.log("traduccion: " + nombreEspañol)
                    console.log("nombreUnico: " + nombreConGuion)
                    console.log("expansion: " + "classic")
                    console.log("crafting : " + {
                        "componentes": arrayComponentes,
                    })
                    agregarProducto(urlNexusProducto, urlNexusCrafting, nombreEspañol, nombreConGuion, arrayComponentes)
                })

        }  
    </script>
</body>

</html>