<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agregar items</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css">
</head>

<body>
    <div class="container">

        <div>
            <div>
                <h2>Agregar nuevos productos</h2>
            </div><br>
            <form>

                <div class="form-group">

                    <div class="form-group col-md-4">
                        <label for="inputAddress">Nombre único:</label>
                        <input type="text" class="form-control" id="campoUnicoNombre"
                            placeholder="Ejemplo: scroll-of-agility-iv">
                    </div>

                    <div class="form-group col-md-4">
                        <label for="inputAddress">Traducción:</label>
                        <input type="text" class="form-control" id="campoTraduccion" placeholder="Nombre en español">
                    </div>

                    <div class="form-group col-md-4">
                        <label for="inputAddress2">Categoría:</label>
                        <select id="selectCategoria" class="form-control">
                        </select>
                        <div>
                            <br>
                            <div class="form-group">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="gridCheck">
                                    <label class="form-check-label" for="gridCheck">
                                        Selecciona si es una nueva categoría
                                    </label>
                                </div>
                            </div>
                            <input disabled type="text" class="form-control" id="campoCategoria"
                                placeholder="Agregar una nueva">
                        </div>
                    </div>
                </div>
                <div class="form-group col-md-4">
                    <label for="inputAddress2">Expansion:</label>
                    <select id="selectExpansion" class="form-control">
                        <option selected>Classic</option>
                        <option selected>Tbc</option>
                        <option selected>Wotlk</option>
                    </select>
                    <br>
            </form>

            <div class="d-flex p-2 justify-content-center">
                <input type="button" id="btnAgregar" class="btn btn-primary" value="Agregar"></button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.9.2/firebase-app.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/9.9.2/firebase-firestore.js"
        import { collection, getDocs, addDoc, doc, setDoc, updateDoc  } from "https://www.gstatic.com/firebasejs/9.9.2/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB4a33fFr6SgUAXjZ6FeFB_XDGL6SKuCuY",
            authDomain: "wowprices-74a82.firebaseapp.com",
            projectId: "wowprices-74a82",
            storageBucket: "wowprices-74a82.appspot.com",
            messagingSenderId: "380944707410",
            appId: "1:380944707410:web:2f229f9fbf99d96e39148b"
        };

        const app = initializeApp(firebaseConfig);

        var infoProductosArray = []
        var campoTraduccion = document.getElementById("campoTraduccion")
        var campoUnicoNombre = document.getElementById("campoUnicoNombre")
        var campoCategoria = document.getElementById("campoCategoria")
        var selectCategoria = document.getElementById("selectCategoria")
        var selectExpansion = document.getElementById("selectExpansion")

        leerDatos()

        document.getElementById('btnAgregar').addEventListener('click', function () {
            agregarProducto()
        });

        async function leerDatos() {
            // Inicializa Firebase si no esta inicializado
            if (!firebase.apps.length) {
                const app = initializeApp(firebaseConfig);
            }
            const db = getFirestore(app);
            const colRef = collection(db, "data");
            const docsSnap = await getDocs(colRef);
            docsSnap.forEach(doc => {

                //agrega las categorias al al dropdown
                for (const key in doc.data().tipo) {
                    const element = doc.data().tipo[key];
                    var daySelect = document.getElementById('selectCategoria');
                    daySelect.options[daySelect.options.length] = new Option(element, element);
                }

                //guarda el json de los productos agregados
                for (const key in doc.data().infoProducts) {
                    //console.log(doc.data().infoProducts[key])
                    infoProductosArray.push(doc.data().infoProducts[key])
                }
            })
            //console.log(infoProductosArray)
        }

        async function agregarProducto() {
            // Inicializa Firebase si no esta inicializado
            if (!firebase.apps.length) {
                const app = initializeApp(firebaseConfig);
            }
            var indicadorDeEnvio = true
            var nombreUnicoTitulo = campoUnicoNombre.value
            const db = getFirestore(app);
            var urlDelProducto = "https://api.nexushub.co/wow-classic/v1/items/pagle-alliance/"+campoUnicoNombre.value

            //Comprobamos el url del producto ya esta en la base de datos
            for (var index = 0; index < infoProductosArray.length; index++) {
                if (infoProductosArray[index].url == urlDelProducto) {
                    indicadorDeEnvio = false
                    console.log("este producto ya existe : " + urlDelProducto)
                    alert("Este producto ya EXISTE!")
                    break
                }
            }

            if (indicadorDeEnvio == true) {

                //Antes de enviar comprueba si todos los campos estan llenos
                if (campoTraduccion.value == "" || campoUnicoNombre.value == "") {
                    alert("Hay campos vacíos, debe llenarlos todos antes de enviar.")

                } else {
                    //Si no existen el url del producto se procede a enviar el nuevo producto
                    await setDoc(doc(db, "data", "datos"), {
                        "infoProducts": {
                            [nombreUnicoTitulo]: {
                                "url": urlDelProducto,
                                "traduccion": campoTraduccion.value,
                                "categoria": selectCategoria.value,
                                "nombreUnico": campoUnicoNombre.value,
                                "expansion": selectExpansion.value,
                                "precioActualizado": 0,
                                "FechaActualizada": "1660503906"
                            }
                        }
                    }, { merge: true }).then(resp => {
                        console.log("Se han guardado los datos")
                        //Luego de guardar los datos limpiamos los campos de texto
                        campoTraduccion.value = ""
                        campoUnicoNombre.value = ""
                        alert("Agregado correctamente!")
                    }).catch(function (reason) {
                        console.log(reason)
                        alert("Hay campos vacíos, debe llenarlos todos antes de enviar.")
                    });
                }

            }
        }
    </script>
</body>

</html>